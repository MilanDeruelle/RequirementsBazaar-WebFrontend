<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/openidconnect-signin/openidconnect-signin-aware.html">
<link rel="import" href="../req-user/req-user.html">
<link rel="import" href="../comments-list/comments-list.html">
<link rel="import" href="../../src/config-behavior.html">
<link rel="import" href="../../src/shared-styles.html">

<dom-module id="requirement-card">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      paper-material {
        display: block;
        border-radius: 2px;
        width: 100%;
        max-width: 800px;
        box-sizing: border-box;
        margin: 5px;
        padding: 0 16px 0 16px;
        background: white;
      }

      .inactive {
        color: #838383;
      }

      .colored {
        color: var(--paper-orange-500);
      }

      .requirementToolbar {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-top: 10px;
        height: 35px;
      }

      .requirementTitle {
        @apply(--layout-flex);
        width: 0;
        font-size: 20px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .requirementIcons {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .requirementIcons paper-menu-button {
        padding: 0px;
      }

      .requirementTime {
        font-size: small;
      }

      paper-material > div {
        margin-bottom: 10px;
      }

      .flex-horizontal {
        @apply(--layout-horizontal);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      .flex-end-align {
        margin-top: auto;
        margin-bottom: auto;
      }

      .editForm {
        display: none;
      }

      paper-button {
        float: right;
        margin: 20px;
      }

      paper-checkbox {
        display: none;
      }

      .line {
        background: #c6c6c6 no-repeat scroll center;
        width: 100%;
        height: 1px;
      }
    </style>

    <openidconnect-signin-aware is-authorized="{{authorized}}"
                                on-openidconnect-signin-aware-success="_handleSigninSuccess"
                                on-openidconnect-signin-aware-signed-out="_handleSignedOut"></openidconnect-signin-aware>

    <iron-signals on-iron-signal-language-changed="_handleLanguageChanged"></iron-signals>

    <iron-ajax id="requirementRequest"
               loading="{{loading}}"
               url="[[_apiBaseUrl]]/requirements/[[requirement.id]]"
               headers="[[authHeader]]"
               last-response="{{requirement}}"></iron-ajax>

    <iron-ajax id="starRequest"
               loading="{{loading}}"
               handle-as="json"
               content-type="application/json"
               headers="[[authHeader]]"
               on-response="_handleStarResponse"
               on-error="errorHandler"></iron-ajax>

    <iron-ajax id="postCommentRequest"
               loading="{{loading}}"
               handle-as="json"
               url="{{_apiBaseUrl}}/comments"
               content-type="application/json"
               method="POST"
               headers="[[authHeader]]"
               on-response="_handleCommentResponse"
               last-response="{{postResponse}}"
               on-error="errorHandler"></iron-ajax>

    <paper-material class="req" id="requirementCard" on-mouseover="showOnHover" on-mouseout="hideOnOut">
      <div id="requirementBody">

        <div class="requirementToolbar">

          <div class="requirementTitle" on-tap="_handleRequirementTap">[[requirement.title]]</div>

          <div class="requirementIcons">
            <paper-checkbox id="checkbox" on-change="_handleCheckboxChange"></paper-checkbox>
            <paper-icon-button icon="[[_calculateStarIcon(requirement.userVoted, authorized)]]"
                               class$="[[_calculateStarClass(requirement.userVoted, authorized)]]"
                               on-tap="_handleStarTap"
                               disabled="[[!authorized]]"></paper-icon-button>
            <div>[[req.upVotes]]</div>
            <paper-menu-button horizontal-align="right"
                               vertical-align="top"
                               hidden="[[!authorized]]"
                               on-paper-dropdown-open="_handleRequirementMenuOpen"
                               on-paper-dropdown-close="_handleRequirementMenuClose"
                               on-iron-select="_handleRequirementMenuSelect">
              <paper-icon-button icon="more-vert" class="dropdown-trigger" alt="menu"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <!--<paper-item on-tap="showGithubRepos">Post as Github Issue</paper-item>-->
                <paper-item value="toggleContributors">[[localize('showContributors')]]</paper-item>
                <paper-item value="follow" hidden="[[_followHidden]]">[[localize('followRequirement')]]</paper-item>
                <paper-item value="unfollow" hidden="[[_unfollowHidden]]">[[localize('unfollowRequirement')]]</paper-item>
                <paper-item value="develop" hidden="[[_developHidden]]">[[localize('developRequirement')]]</paper-item>
                <paper-item value="undevelop" hidden="[[_undevelopHidden]]">[[localize('undevelopRequirement')]]</paper-item>
                <paper-item value="becomeLeadDeveloper" hidden="[[_becomeLeadDeveloperHidden]]">[[localize('becomeLeadDeveloper')]]</paper-item>
                <paper-item value="unbecomeLeadDeveloper" hidden="[[_unbecomeLeadDeveloperHidden]]">[[localize('stopLeadDeveloper')]]</paper-item>
                <paper-item value="edit" hidden$="[[requirement.realized]]">[[localize('editRequirement')]]</paper-item>
                <paper-item value="realize" hidden$="[[requirement.realized]]">[[localize('markAsDone')]]</paper-item>
                <paper-item value="unrealize" hidden$="[[!requirement.realized]]">[[localize('markAsUndone')]]</paper-item>
                <paper-item value="delete">[[localize('deleteRequirement')]]</paper-item>
              </paper-menu>
            </paper-menu-button>
          </div>

        </div>

        <div class="requirementTime">
          <relative-time datetime$="[[requirement.creation_time]]"></relative-time>
          [[localize('by')]]
          <req-user user="[[requirement.creator]]" normal-view></req-user>
        </div>

      </div>

      <div class="line"></div>

      <div id="contributors" hidden>
        <div>[[localize('creator')]]: <req-user user="[[requirement.creator]]" full-view></req-user></div>
        <div>[[localize('leadDeveloper')]]: <req-user user="[[requirement.leadDeveloper]]" full-view></req-user></div>
        <div>[[localize('developers')]]:
          <template is="dom-repeat" items="{{requirement.developers}}" as="developer">
            <div style="display:inline-block">
              <req-user user="[[developer]]" mini></req-user>
              <paper-tooltip>{{developer.userName}}</paper-tooltip>
            </div>
          </template>
        </div>
        <div>[[localize('followers')]]:
          <template is="dom-repeat" items="{{requirement.followers}}" as="foll">
            <div style="display:inline-block">
              <req-user user="[[foll]]" mini></req-user>
              <paper-tooltip>{{foll.userName}}</paper-tooltip>
            </div>
          </template>
        </div>

        <div class="line" style="margin-top: 10px;"></div>

      </div>

      <div class="description inactive" inner-h-t-m-l="{{validateUrl(requirement.description)}}" id="description"></div>

      <div class="comments" id="comments">

        <iron-collapse no-animation>
          <file-gallery attachments="{{requirement.attachments}}"></file-gallery>
          <h4 style="margin:0px;padding:10px 0px 10px 0px;">[[localize('comments')]]</h4>
          <comments-list id="commentsList" loading="{{loading}}" requirement-id="[[requirement.id]]" data-a="[[requirement.id]]"></comments-list>
          <div class="container flex-horizontal" id="[[requirement.id]]" hidden="[[!authorized]]">
            <paper-input id="commentInput" is="iron-input" on-input="_handleCommentInput" label="[[localize('addComment')]]" class="flexchild" on-keydown="_handleCommentEnter">
              <!--<emoji-selector suffix></emoji-selector>-->
            </paper-input>
            <paper-icon-button id="commentSendButton" mini icon="send" class="flex-end-align" on-tap="_handleAddCommentTap" hidden></paper-icon-button>
          </div>
        </iron-collapse>

      </div>

      <div class="editForm" id="edit">

        <paper-input class="editTitle title" value="{{requirement.title}}"></paper-input>
        <paper-textarea value="{{requirement.description}}"></paper-textarea>
        <paper-button raised on-tap="_handleSaveEditTap" data-args="[[requirement.title]]">[[localize('save')]]</paper-button>
        <paper-button raised on-tap="_handleCancelEditTap" data-args="[[requirement.title]]">[[localize('cancel')]]</paper-button>

      </div>

    </paper-material>

  </template>

  <script>
    Polymer({
      is: 'requirement-card',

      properties: {
        route: {
          type: Object,
          notify: true
        },
        /**
         * Whether any loading operation is currently active.
         */
        loading: {
          type: Boolean,
          notify: true
        },
        authorized: {
          type: Boolean,
          observer: '_authorizedChanged'
        },
        opened: {
          type: Boolean,
          reflectToAttribute: true
        },
        requirement: {
          type: Object,
          notify: true
        },
        _followHidden: {
          type: Boolean
        },
        _unfollowHidden: {
          type: Boolean
        },
        _developHidden: {
          type: Boolean
        },
        _undevelopHidden: {
          type: Boolean
        },
        _becomeLeadDeveloperHidden: {
          type: Boolean
        },
        _unbecomeLeadDeveloperHidden: {
          type: Boolean
        }
      },

      behaviors: [
        Polymer.IronResizableBehavior,
        Polymer.AppLocalizeBehavior,
        ConfigBehavior
      ],

      observers: [
        '_requirementChanged(authorized, requirement.*)'
      ],

      attached: function() {
        // load localized messages
        this.loadResources(this.resolveUrl('../../locales/locales.json'));
      },

      /**
       * Handles tapping a requirement.
       *
       * @param e
       */
      _handleRequirementTap: function(e) {
        var requirementNode = this.$.requirementCard;
        var descriptionNode = this.$.description;

        if (requirementNode.querySelector('iron-collapse').opened) {
          // remove elevation
          requirementNode.elevation = 1;
          // close the requirement
          requirementNode.querySelector('iron-collapse').hide();
          // make description gray
          descriptionNode.classList.toggle('inactive');
          // reset route
          this.set('route.path', '');
        } else {
          // set elevation
          requirementNode.elevation = 4;
          // open the requirement
          requirementNode.querySelector('iron-collapse').show();
          // make description gray
          descriptionNode.classList.toggle('inactive');
          // load comments
          requirementNode.querySelector('comments-list').refresh();
          // load attachments
          requirementNode.querySelector("file-gallery").loadIcons();
          this.set('route.path', '/requirements/' + this.requirement.id);
        }

        this.fire('iron-signal', {name: 'resize'});
      },

      /**
       * Calculates the specific star icon to show for the voting feature of the requirements.
       *
       * @param vote the vote field coming from the backend, either 'UP_VOTE' or 'NO_VOTE'.
       * @param authorized whether the user is currently logged in or not.
       * @returns {string} the icon, either a filled star or just the outlines of a star.
       * @private
       */
      _calculateStarIcon: function(vote, authorized) {
        if (authorized && (vote === 'UP_VOTE')) {
          return 'star';
        }
        return 'star-border';
      },

      /**
       * Calculates the CSS class for the star icon of the voting feature of the requirements.
       *
       * @param vote the vote field coming from the backend, either 'UP_VOTE' or 'NO_VOTE'.
       * @param authorized whether the user is currently logged in or not.
       * @returns {string} the CSS class for the star icon.
       * @private
       */
      _calculateStarClass: function(vote, authorized) {
        if (authorized && (vote === 'UP_VOTE')) {
          return 'colored';
        }
      },

      validateUrl: function(requirementDesc) {
        var str = requirementDesc;
        var expression = /\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost(?=\/)|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi;
        var regex = new RegExp(expression);

        if(!str.match(regex)) {
          return str;
        } else {
          var txt = str;
          for (var i = 0; i < str.match(regex).length; i++) {
            var replacement;
            if (str.match(regex)[i].startsWith("http")) {
              replacement = "<a href='" + str.match(regex)[i] + "' target='_blank' class='highlight'>"+ str.match(regex)[i] +"</a>"
            } else {
              replacement = "<a href='http://" + str.match(regex)[i] + "' target='_blank' class='highlight'>"+ str.match(regex)[i] +"</a>"
            }
            txt = txt.replace(str.match(regex)[i], replacement);
          }
          return txt;
        }
      },

      /**
       * Calculates the localized message for the realized menu button, depending on whether the requirement is realized or
       * not.
       *
       * @param realized
       * @returns {*}
       * @private
       */
      _calculateRealizeMessage: function(realized) {
        if (realized) {
          return this.async(function() { this.localize('markAsUnDone');}.bind(this), 100);//this.localize('markAsUnDone');
        } else {
          return this.async(function() { this.localize('markAsDone');}.bind(this), 100);// this.localize('markAsDone');
        }
      },

      _requirementChanged: function(authorized, requirementChange) {
        var requirement = requirementChange.value;
        if (requirement.realized) {
          // following
          this._followHidden = true;
          this._unfollowHidden = true;
          // developing
          this._developHidden = true;
          this._undevelopHidden = true;
          // lead developer
          this._becomeLeadDeveloperHidden = true;
          this._unbecomeLeadDeveloperHidden = true;
        } else {
          // following
          if (authorized && this.currentUser && this._isUserInArray(requirement.followers, this.currentUser)) {
            this._followHidden = true;
            this._unfollowHidden = false;
          } else {
            this._followHidden = false;
            this._unfollowHidden = true;
          }
          // developing
          if (this.authorized && this.currentUser && this._isUserInArray(requirement.developers, this.currentUser)) {
            this._developHidden = true;
            this._undevelopHidden = false;
          } else {
            this._developHidden = false;
            this._undevelopHidden = true;
          }
          // lead developer
          if (this.currentUser && requirement.leadDeveloper && (this.currentUser.id === requirement.leadDeveloper.id)) {
            this._becomeLeadDeveloperHidden = true;
            this._unbecomeLeadDeveloperHidden = false;
          } else {
            this._becomeLeadDeveloperHidden = false;
            this._unbecomeLeadDeveloperHidden = true;
          }
        }
      },

      showOnHover: function(e) {
        this.$.checkbox.style.display = "block";
      },

      hideOnOut: function (e) {
        if (!this.$.checkbox.checked) {
          this.$.checkbox.style.display = "none";
        }
      },

      _handleCheckboxChange: function(e) {
        var requirementId = e.model.req.id;
        if (e.target.checked) {
          this.push('selectedRequirements', requirementId);
        } else {
          var index = this.selectedRequirements.indexOf(requirementId);
          if (index > -1) {
            this.splice('selectedRequirements', index, 1);
          }
        }
        this.$.bottomToolbar.hidden = (this.selectedRequirements.length === 0)
      },

      _authorizedChanged: function(newValue) {
        //this.fire('iron-signal', {name: 'resize'});
      },

      /**
       * Checks whether a user is in the users array. Compares the user's id.
       *
       * @param usersArray an array of user objects.
       * @param user a user object.
       * @returns {boolean} whether the user is in the array or not.
       * @private
       */
      _isUserInArray: function(usersArray, user) {
        if (user === null) {
          return false;
        } else {
          // check if the user's id is in the users array
          for (var index = 0; index < usersArray.length; ++index) {
            if (usersArray[index].id === user.id) {
              return true;
            }
          }

          return false;
        }
      },

      /**
       * Handles toggling the following of requirements by firing the state to the server.
       *
       * @param requirement the requirement to (un)follow.
       * @returns {boolean}
       * @private
       */
      _toggleFollowRequirement: function(requirement) {
        var requirementId = requirement.id;

        var followers = requirement.followers;
        var isFollower = this._isUserInArray(followers, this.currentUser);

        var request = this.$.followRequest;
        request.url = this._apiBaseUrl + "/requirements/" + requirementId + "/followers";

        if (!isFollower) {
          // follow requirement
          request.method = 'POST';
        } else {
          // unfollow requirement
          request.method = 'DELETE';
        }

        request.generateRequest();
      },

      /**
       * Handles toggling the existence of a user within an HTTP resource.
       * TODO: currently only for resource 'developers'
       *
       * @param e
       * @returns {boolean}
       * @private
       */
      _toggleUserInResource: function(requirementId, userArray, resource) {
        var isUserInArray = this._isUserInArray(userArray, this.currentUser);

        var request = this.$.userInResourceRequest;
        request.url = this._apiBaseUrl + "/requirements/" + requirementId + "/" + resource;

        if (!isUserInArray) {
          // POST user to resource
          request.method = 'POST';
        } else {
          // DELETE user from resource
          request.method = 'DELETE';
        }

        request.generateRequest();
      },

      /**
       * Event handler for requirement's paper-menu.
       *
       * @param e
       * @private
       */
      _handleRequirementMenuSelect: function(e) {
        // unselect the selected menu item
        e.target.selected = null;
        // get value of the paper-item
        var selectedValue = e.detail.item.getAttribute('value');

        if ((selectedValue === 'follow') || (selectedValue === 'unfollow')) {
          this._toggleFollowRequirement();
        } else if (selectedValue === 'toggleContributors') {
          this._toggleContributors();
        } else if ((selectedValue === 'develop') || (selectedValue === 'undevelop')) {
          this._toggleUserInResource(requirement.id, requirement.developers, 'developers');
        } else if ((selectedValue === 'realize') || (selectedValue === 'unrealize')) {
          this._toggleRealized(requirement);
        } else if (selectedValue === 'delete') {
          this.requirementToDelete = requirement;
          this.$.modal.open();
        } else if ((selectedValue === 'becomeLeadDeveloper') || (selectedValue === 'unbecomeLeadDeveloper')) {
          this._toggleLeadDeveloper(requirement);
        } else if (selectedValue === 'edit') {
          this._editRequirement(requirement.id);
        }
      },

      _handleRequirementMenuOpen: function(e) {
        this.fire('iron-signal', {name: 'menu-open', data: this});
      },

      _handleRequirementMenuClose: function(e) {
        this.fire('iron-signal', {name: 'menu-close', data: this});
      },

      /**
       * Handles tapping the star icon.
       *
       * @param e
       * @private
       */
      _handleStarTap: function(e) {
        var request = this.$.starRequest;
        var vote = this.requirement.userVoted;
        request.url = this._apiBaseUrl + "/requirements/" + this.requirement.id + "/votes";

        // now construct the method and body based on the action
        if (vote === 'NO_VOTE') {
          request.method = 'POST';

          // give user immediate feedback
          Polymer.dom(e).localTarget.toggleClass('colored');
          e.target.setAttribute('icon', 'star');
        } else {
          request.method = 'DELETE';

          // give user immediate feedback
          Polymer.dom(e).localTarget.toggleClass('colored');
          e.target.setAttribute('icon', 'star-border');
        }

        // fire the event to the server
        request.generateRequest();
      },

      /**
       * Event handler for the iron-ajax for submitting votes to the server.
       *
       * @param e
       * @private
       */
      _handleStarResponse: function(e) {
        var status = e.detail.status;
        var feedback;

        if (status === 200) {
          feedback = this.localize('unvoteSuccessful');
        } else if (status === 201) {
          // delete successful
          feedback = this.localize('voteSuccessful');
        } else {
          //TODO: add i18n
          feedback = 'error';
        }

        this.fire('iron-signal', {name: 'show-toast', data: feedback});

        // now refresh the data behind by reloading all requirements
        // refreshing the requirement
        this.$.requirementRequest.generateRequest();
      },

      _handleCommentInput: function(e) {
        this.$.commentSendButton.hidden = false;
      },

      _handleCommentEnter: function (e) {
        //TODO: refactor the code
        // keyCode 13 is Enter
        if (e.keyCode === 13) {
          // check if the Enter key was pressed...
          if (!e.ctrlKey) {
            this._handleAddCommentTap(e);
            e.preventDefault();
          } else {
            e.currentTarget.value += "<br/>";
          }
        }
      },

      _handleAddCommentTap: function(e) {
        var request = this.$.postCommentRequest;
        var message = this.$.commentInput.value;

        if (message != null && (message !== '')) {
          request.body = JSON.stringify({
            "requirementId": this.requirement.id,
            "message": message
          });
          request.generateRequest();

          this.$.commentInput.value = '';
        }
      },

      _handleCommentResponse: function(data) {
        var requirementId = data.detail.response.requirementId;

        // reload comments
        this.$.commentsList.refresh();

        //TODO: Add a toast message that the comment was saved successfully.
      },

      /**
       * Toggles the state of contributors' bar.
       *
       * @param requirement a requirement object.
       * @private
       */
      _toggleContributors: function() {
        var contributorNode = this.$.contributors;
        this.toggleAttribute('hidden', contributorNode.getAttribute('hidden') == null, contributorNode);
        // notify outer iron-list
        this.fire('iron-signal', {name: 'resize'});
      },

    });
  </script>
</dom-module>