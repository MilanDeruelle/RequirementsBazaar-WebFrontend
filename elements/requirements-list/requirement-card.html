<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../src/config-behavior.html">
<link rel="import" href="../../src/shared-styles.html">

<dom-module id="requirement-card">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>

    <paper-material class="req" id="requirement[[req.id]]" on-mouseover="showOnHover" on-mouseout="hideOnOut">
      <div id$="requirementBody{{req.id}}">

        <div class="requirementToolbar">

          <div class="requirementTitle" on-tap="_handleRequirementTap">[[req.title]]</div>

          <div class="requirementIcons">
            <paper-checkbox id="checkbox[[req.id]]" on-change="_handleCheckboxChange"></paper-checkbox>
            <paper-icon-button icon="[[_calculateStarIcon(req.userVoted, authorized)]]"
                               class$="[[_calculateStarClass(req.userVoted, authorized)]]"
                               on-tap="_handleStarTap"
                               disabled="[[!authorized]]"></paper-icon-button>
            <div>[[req.upVotes]]</div>
            <paper-menu-button horizontal-align="right" vertical-align="top" hidden="[[!authorized]]" on-iron-select="_handleRequirementMenuSelect">
              <paper-icon-button icon="more-vert" class="dropdown-trigger" alt="menu"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <!--<paper-item on-tap="showGithubRepos">Post as Github Issue</paper-item>-->
                <paper-item value="toggleContributors">[[localize('showContributors')]]</paper-item>
                <paper-item value="follow" hidden$="[[req.realized]]">[[_calculateMessageBasedOnUserInArray(req.followers, 'followRequirement', 'unfollowRequirement')]]</paper-item>
                <paper-item value="develop" hidden$="[[req.realized]]">[[_calculateMessageBasedOnUserInArray(req.developers, 'developRequirement', 'undevelopRequirement')]]</paper-item>
                <paper-item value="becomeLeadDeveloper" hidden$="[[req.realized]]">[[_calculateLeadDeveloperLocalization(req.leadDeveloper)]]</paper-item>
                <paper-item value="edit" hidden$="[[req.realized]]">[[localize('editRequirement')]]</paper-item>
                <paper-item value="realize">[[_calculateRealizeMessage(req.realized)]]</paper-item>
                <paper-item value="delete">[[localize('deleteRequirement')]]</paper-item>
              </paper-menu>
            </paper-menu-button>
          </div>

        </div>

        <div class="requirementTime">
          <relative-time datetime$="[[req.creation_time]]"></relative-time>
          [[localize('by')]]
          <req-user user="[[req.creator]]" normal-view></req-user>
        </div>

      </div>

      <div class="line"></div>

      <div id$="contributors[[req.id]]" hidden>
        <div>[[localize('creator')]]: <req-user user="[[req.creator]]" full-view></req-user></div>
        <div>[[localize('leadDeveloper')]]: <req-user user="[[req.leadDeveloper]]" full-view></req-user></div>
        <div>[[localize('developers')]]:
          <template is="dom-repeat" items="{{req.developers}}" as="developer">
            <div style="display:inline-block">
              <req-user user="[[developer]]" mini></req-user>
              <paper-tooltip>{{developer.userName}}</paper-tooltip>
            </div>
          </template>
        </div>
        <div>[[localize('followers')]]:
          <template is="dom-repeat" items="{{req.followers}}" as="foll">
            <div style="display:inline-block">
              <req-user user="[[foll]]" mini></req-user>
              <paper-tooltip>{{foll.userName}}</paper-tooltip>
            </div>
          </template>
        </div>

        <div class="line" style="margin-top: 10px;"></div>

      </div>

      <div class="description inactive" inner-h-t-m-l="{{validateUrl(req.description)}}" id$="description[[req.id]]"></div>

      <div class="comments" id$="comments{{req.id}}">

        <iron-collapse>
          <file-gallery attachments="{{req.attachments}}"></file-gallery>
          <h4 style="margin:0px;padding:10px 0px 10px 0px;">[[localize('comments')]]</h4>
          <comments-list requirement-id="[[req.id]]" data-a="[[req.id]]" base-href="{{_apiBaseUrl}}"></comments-list>
          <div class="container flex-horizontal" id="[[req.id]]" hidden="[[!authorized]]">
            <paper-input id="comment[[req.id]]" is="iron-input" on-input="_handleCommentInput" label="[[localize('addComment')]]" class="flexchild" on-keydown="_handleCommentEnter">
              <!--<emoji-selector suffix></emoji-selector>-->
            </paper-input>
            <paper-icon-button id$="sendComment[[req.id]]" mini icon="send" class="flex-end-align" on-tap="_handleAddCommentTap" hidden></paper-icon-button>
          </div>
        </iron-collapse>

      </div>

      <div class="editForm" id$="edit{{req.id}}">

        <paper-input class="editTitle title" value="{{req.title}}"></paper-input>
        <paper-textarea value="{{req.description}}"></paper-textarea>
        <paper-button raised on-tap="_handleSaveEditTap" data-args="[[req.title]]">[[localize('save')]]</paper-button>
        <paper-button raised on-tap="_handleCancelEditTap" data-args="[[req.title]]">[[localize('cancel')]]</paper-button>

      </div>

    </paper-material>

  </template>

  <script>
    Polymer({
      is: 'requirement-card',

      properties: {
        opened: {
          type: Boolean,
          reflectToAttribute: true
        },
        requirementItem: {
          type: Object
        }
      },

      behaviors: [
        Polymer.AppLocalizeBehavior,
        ConfigBehavior
      ]
    });
  </script>
</dom-module>