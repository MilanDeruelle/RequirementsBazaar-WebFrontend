<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/openidconnect-signin/openidconnect-signin-aware.html">
<link rel="import" href="../req-user/req-user.html">
<link rel="import" href="../comments-list/comments-list.html">
<link rel="import" href="../../src/config-behavior.html">
<link rel="import" href="../../src/shared-styles.html">

<dom-module id="requirement-card">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      paper-material {
        display: block;
        border-radius: 2px;
        width: 100%;
        max-width: 800px;
        box-sizing: border-box;
        margin: 5px;
        padding: 0 16px 0 16px;
        background: white;
      }

      .inactive {
        color: #838383;
      }

      .requirementToolbar {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        margin-top: 10px;
        height: 35px;
      }

      .requirementTitle {
        @apply(--layout-flex);
        width: 0;
        font-size: 20px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .requirementIcons {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      .requirementIcons paper-menu-button {
        padding: 0px;
      }

      .requirementTime {
        font-size: small;
      }

      paper-material > div {
        margin-bottom: 10px;
      }

      .flex-horizontal {
        @apply(--layout-horizontal);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      .flex-end-align {
        margin-top: auto;
        margin-bottom: auto;
      }

      .editForm {
        display: none;
      }

      paper-button {
        float: right;
        margin: 20px;
      }

      paper-checkbox {
        display: none;
      }

      .line {
        background: #c6c6c6 no-repeat scroll center;
        width: 100%;
        height: 1px;
      }
    </style>

    <openidconnect-signin-aware is-authorized="{{authorized}}"
                                on-openidconnect-signin-aware-success="_handleSigninSuccess"
                                on-openidconnect-signin-aware-signed-out="_handleSignedOut"></openidconnect-signin-aware>

    <iron-signals on-iron-signal-language-changed="_handleLanguageChanged"></iron-signals>

    <paper-material class="req" id="requirementCard" on-mouseover="showOnHover" on-mouseout="hideOnOut">
      <div id="requirementBody">

        <div class="requirementToolbar">

          <div class="requirementTitle" on-tap="_handleRequirementTap">[[requirement.title]]</div>

          <div class="requirementIcons">
            <paper-checkbox id="checkbox" on-change="_handleCheckboxChange"></paper-checkbox>
            <paper-icon-button icon="[[_calculateStarIcon(requirement.userVoted, authorized)]]"
                               class$="[[_calculateStarClass(requirement.userVoted, authorized)]]"
                               on-tap="_handleStarTap"
                               disabled="[[!authorized]]"></paper-icon-button>
            <div>[[req.upVotes]]</div>
            <paper-menu-button horizontal-align="right" vertical-align="top" hidden="[[!authorized]]" on-iron-select="_handleRequirementMenuSelect">
              <paper-icon-button icon="more-vert" class="dropdown-trigger" alt="menu"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <!--<paper-item on-tap="showGithubRepos">Post as Github Issue</paper-item>-->
                <paper-item value="toggleContributors">[[localize('showContributors')]]</paper-item>
                <paper-item value="follow" hidden$="[[requirement.realized]]">[[_calculateMessageBasedOnUserInArray(requirement.followers, 'followRequirement', 'unfollowRequirement')]]</paper-item>
                <paper-item value="develop" hidden$="[[requirement.realized]]">[[_calculateMessageBasedOnUserInArray(requirement.developers, 'developRequirement', 'undevelopRequirement')]]</paper-item>
                <paper-item value="becomeLeadDeveloper" hidden$="[[requirement.realized]]">[[_calculateLeadDeveloperLocalization(requirement.leadDeveloper)]]</paper-item>
                <paper-item value="edit" hidden$="[[requirement.realized]]">[[localize('editRequirement')]]</paper-item>
                <paper-item value="realize">[[_calculateRealizeMessage(requirement.realized)]]</paper-item>
                <paper-item value="delete">[[localize('deleteRequirement')]]</paper-item>
              </paper-menu>
            </paper-menu-button>
          </div>

        </div>

        <div class="requirementTime">
          <relative-time datetime$="[[requirement.creation_time]]"></relative-time>
          [[localize('by')]]
          <req-user user="[[requirement.creator]]" normal-view></req-user>
        </div>

      </div>

      <div class="line"></div>

      <div id$="contributors[[requirement.id]]" hidden>
        <div>[[localize('creator')]]: <req-user user="[[requirement.creator]]" full-view></req-user></div>
        <div>[[localize('leadDeveloper')]]: <req-user user="[[requirement.leadDeveloper]]" full-view></req-user></div>
        <div>[[localize('developers')]]:
          <template is="dom-repeat" items="{{requirement.developers}}" as="developer">
            <div style="display:inline-block">
              <req-user user="[[developer]]" mini></req-user>
              <paper-tooltip>{{developer.userName}}</paper-tooltip>
            </div>
          </template>
        </div>
        <div>[[localize('followers')]]:
          <template is="dom-repeat" items="{{requirement.followers}}" as="foll">
            <div style="display:inline-block">
              <req-user user="[[foll]]" mini></req-user>
              <paper-tooltip>{{foll.userName}}</paper-tooltip>
            </div>
          </template>
        </div>

        <div class="line" style="margin-top: 10px;"></div>

      </div>

      <div class="description inactive" inner-h-t-m-l="{{validateUrl(requirement.description)}}" id$="description[[requirement.id]]"></div>

      <div class="comments" id$="comments{{requirement.id}}">

        <iron-collapse>
          <file-gallery attachments="{{requirement.attachments}}"></file-gallery>
          <h4 style="margin:0px;padding:10px 0px 10px 0px;">[[localize('comments')]]</h4>
          <comments-list requirement-id="[[requirement.id]]" data-a="[[requirement.id]]" base-href="{{_apiBaseUrl}}"></comments-list>
          <div class="container flex-horizontal" id="[[requirement.id]]" hidden="[[!authorized]]">
            <paper-input id="comment[[requirement.id]]" is="iron-input" on-input="_handleCommentInput" label="[[localize('addComment')]]" class="flexchild" on-keydown="_handleCommentEnter">
              <!--<emoji-selector suffix></emoji-selector>-->
            </paper-input>
            <paper-icon-button id$="sendComment[[requirement.id]]" mini icon="send" class="flex-end-align" on-tap="_handleAddCommentTap" hidden></paper-icon-button>
          </div>
        </iron-collapse>

      </div>

      <div class="editForm" id$="edit{{requirement.id}}">

        <paper-input class="editTitle title" value="{{requirement.title}}"></paper-input>
        <paper-textarea value="{{requirement.description}}"></paper-textarea>
        <paper-button raised on-tap="_handleSaveEditTap" data-args="[[requirement.title]]">[[localize('save')]]</paper-button>
        <paper-button raised on-tap="_handleCancelEditTap" data-args="[[requirement.title]]">[[localize('cancel')]]</paper-button>

      </div>

    </paper-material>

  </template>

  <script>
    Polymer({
      is: 'requirement-card',

      properties: {
        opened: {
          type: Boolean,
          reflectToAttribute: true
        },
        requirement: {
          type: Object,
          notify: true
        }
      },

      behaviors: [
        Polymer.AppLocalizeBehavior,
        ConfigBehavior
      ],

      attached: function() {
        // load localized messages
        this.loadResources(this.resolveUrl('../../locales/locales.json'));
      },

      ready: function() {
        console.log('hey');
      },

      /**
       * Handles tapping a requirement.
       *
       * @param e
       */
      _handleRequirementTap: function(e) {
        var requirementNode = this.$$('#requirement' + e.model.req.id);
        var descriptionNode = requirementNode.querySelector('#description' + e.model.req.id);

        if (requirementNode.querySelector('iron-collapse').opened) {
          // remove elevation
          requirementNode.elevation = 1;
          // close the requirement
          requirementNode.querySelector('iron-collapse').hide();
          // make description gray
          descriptionNode.classList.toggle('inactive');
          // reset route
          this.set('route.path', '');
        } else {
          // set elevation
          requirementNode.elevation = 4;
          // open the requirement
          requirementNode.querySelector('iron-collapse').show();
          // make description gray
          descriptionNode.classList.toggle('inactive');
          // load comments
          requirementNode.querySelector('comments-list').refresh();
          // load attachments
          requirementNode.querySelector("file-gallery").loadIcons();
          this.set('route.path', '/requirements/' + e.model.req.id);
        }
      },
    });
  </script>
</dom-module>