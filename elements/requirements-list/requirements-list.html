<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/openidconnect-signin/openidconnect-signin-aware.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../req-user/req-user.html">
<link rel="import" href="../comments-list/comments-list.html">
<link rel="import" href="../file-gallery/file-gallery.html">
<link rel="import" href="requirement-card.html">
<link rel="import" href="../../src/shared-styles.html">
<link rel="import" href="../../src/config-behavior.html">

<script src="../../bower_components/masonry/dist/masonry.pkgd.min.js"></script>

<dom-module id="requirements-list">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        height: 100%;
        width: 100%;
      }

      paper-card {
        max-width: 300px;
        min-width: 300px;
      }

      #requirementsList {
        @apply(--layout-center);
        height: 100%;
        width: 100%;
      }

      paper-material {
        display: block;
        border-radius: 2px;
        width: 100%;
        max-width: 800px;
        box-sizing: border-box;
        margin: 5px;
        padding: 0 16px 0 16px;
        background: white;
      }

      paper-fab {
        --paper-fab-background: var(--default-primary-color);
      }

      paper-toast {
        z-index: 105;
      }

      .flex-horizontal {
        @apply(--layout-horizontal);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      .flex-end-align {
        margin-top: auto;
        margin-bottom: auto;
      }

      paper-button {
        float: right;
        margin: 20px;
      }

      .hide {
        display: none;
      }

      #bottomToolbar {
        position: fixed;
        bottom: 50px;
        left: 10px;
        z-index: 105;
        width: auto;
        padding: 10px;
      }

      #grid .starIcon {
        float: right;
        margin: 20px;
      }

      .grid-item {
        margin: 5px;
        margin-bottom: 10px;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/requirements/:requirementId"
      data="{{data}}"></app-route>

    <openidconnect-signin-aware is-authorized="{{authorized}}"
                                on-openidconnect-signin-aware-success="_handleSigninSuccess"
                                on-openidconnect-signin-aware-signed-out="_handleSignedOut"></openidconnect-signin-aware>

    <iron-signals on-iron-signal-language-changed="_handleLanguageChanged"></iron-signals>

    <iron-signals on-iron-signal-resize="_handleIronResize"></iron-signals>

    <iron-signals on-iron-signal-menu-open="_handleMenuOpen"></iron-signals>

    <iron-signals on-iron-signal-menu-close="_handleMenuClose"></iron-signals>

    <iron-signals on-iron-signal-show-toast="_handleShowToast"></iron-signals>

    <iron-ajax
      id="requirementsRequest"
      loading="{{loading}}"
      url="[[_resourceURL]]"
      headers="[[authHeader]]"
      params="[[_requirementsRequestParameters]]"
      on-response="_handleRequirementsResponse"></iron-ajax>

    <iron-ajax
      id="postUpdateRequirement"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="PUT"
      headers="[[authHeader]]"
      on-response="handleResponseEditReq"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="updateRequirementRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="PUT"
      headers="[[authHeader]]"
      on-response="_handleUpdateRequirementResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="deleteRequirementRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="DELETE"
      headers="[[authHeader]]"
      on-response="_handleDeleteRequirementResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="followRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      headers="[[authHeader]]"
      on-response="_handleFollowResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="userInResourceRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      headers="[[authHeader]]"
      on-response="_handleUserInResourceResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="postCommentRequest"
      loading="{{loading}}"
      handle-as="json"
      url="{{_apiBaseUrl}}/comments"
      content-type="application/json"
      method="POST"
      headers="[[authHeader]]"
      on-response="_handleCommentResponse"
      last-response="{{postResponse}}"
      on-error="errorHandler"></iron-ajax>

        <!--<iron-ajax-->
                <!--id="postIssueGit"-->
                <!--handle-as="json"-->
                <!--content-type="application/json"-->
                <!--params='{"access_token": ""}'-->
                <!--method="POST"-->
                <!--on-response="handleResponseGithubIssue"-->
                <!--on-error="errorHandler"></iron-ajax>-->

        <!--<iron-ajax-->
                <!--id="getSearchGit"-->
                <!--handle-as="json"-->
                <!--content-type="application/json"-->
                <!--method="GET"-->
                <!--last-response="{{searchRepositories}}"-->
                <!--on-response="showRepoSearchResults"-->
                <!--on-error="errorHandler"></iron-ajax>-->

    <iron-list id="requirementsList" items="[[requirements]]" scroll-target="document">
      <template>
        <requirement-card loading="{{loading}}" route="{{route}}" requirement="[[item.requirementItem]]"></requirement-card>
      </template>
    </iron-list>

    <!-- this element will load more data when the user scrolls down and reached the lower threshold -->
    <iron-scroll-threshold id="scrollThreshold"
                           lower-threshold="500"
                           on-lower-threshold="_loadMoreData"
                           scroll-target="requirementsList">
    </iron-scroll-threshold>

    <!-- Dialog for GitHub export functionality: -->

    <paper-dialog id="reposContainer" on-iron-overlay-closed="onRepoDialogClosed">
      <h2>Your Github Repositories</h2>
      <paper-dialog-scrollable>
        <paper-input id="searchGithubRepo" label="Search a Github Repository" on-keydown="searchGithubRepo">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
        <iron-selector id="selRepo" selected="0">
          <template is="dom-repeat" items$="{{repositories}}" id="repoElements">
            <paper-item>
              <paper-item-body two-line>
                <div>{{item.name}}</div>
                <div secondary>{{item.description}}</div>
              </paper-item-body>
            </paper-item>
          </template>
        </iron-selector>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>POST</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for confirming the deletion of a requirement: -->

    <paper-dialog id="modal" modal on-iron-overlay-closed="_handleDeleteRequirement" entry-animation="fade-in-animation"
                  exit-animation="fade-out-animation">
      <h2>[[localize('deleteRequirement')]]?</h2>
      <p>[[localize('deleteRequirementDesc')]]</p>
      <div class="buttons">
        <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
        <paper-button dialog-confirm autofocus>[[localize('delete')]]</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for showing comments in the grid view: -->

    <paper-dialog id="commentsDialog" on-iron-overlay-closed="deleteLeftoverComment" entry-animation="fade-in-animation" exit-animation="fade-out-animation"
                  style="min-width:40%; max-width:85%; top:100px; max-height: 80%; overflow:scroll;">
      <h2>[[localize('comments')]]</h2>
      <p style="max-height: 80%;">
        <comments-list base-href="{{_apiBaseUrl}}"></comments-list>
      <div class="container flex-horizontal" hidden="[[!authorized]]">
        <paper-input is="iron-input" on-input="showSendButton" label="[[localize('addComment')]]" class="flexchild comments-input" on-keydown="_handleCommentEnter">
        </paper-input>
        <paper-fab id="fab" mini icon="send" class="flex-end-align" on-tap="postGridComment"></paper-fab>
      </div>
      </p>
    </paper-dialog>

    <!-- Floating toolbar for selected requirements: -->

    <paper-material elevation="5" id="bottomToolbar" hidden>
      <span>{{selectedRequirements.length}} Requirements selected.</span>
      <paper-icon-button icon="file-download" on-tap="downloadRequirements"></paper-icon-button>
      <paper-icon-button icon="close" on-tap="closeBottomToolbar"></paper-icon-button>
    </paper-material>

    <!-- Toast for toast notifications: -->

    <paper-toast id="toast" text="[[toastFeedback]]"></paper-toast>

  </template>

  <script>
    (function () {
      //'use strict';

      Polymer({
        is: 'requirements-list',
        listeners: {
          //'change': 'addToSelectedReq'
        },

        behaviors: [
          Polymer.AppLocalizeBehavior,
          ConfigBehavior
        ],

        properties: {
          route: {
            type: Object,
            notify: true
          },
          categoryId: {
            type: Number
          },
          /**
           * Whether to show 'open' or 'realized' requirements.
           */
          requirementsStateFilter: {
            type: String,
            notify: true,
            value: 'open'
          },
          viewOption: {
            type: String,
            value: 'list'
          },
          _resourceURL: {
            type: String,
            computed: '_computeResourceURL(_apiBaseUrl, categoryId)'
          },
          requirements: {
            type: Array
          },
          selectedRequirements: {
            type: Array,
            value: [],
            notify: true
          },
          postUrl: String,
          body: Object,
          postResponse: Object,
          /**
           * The text shown on the paper-toast element for notifying the user.
           */
          toastFeedback: String,
          header: {
            type:Object,
            notify: true
          },
          /**
           * The parameters for the request to the requirements resource.
           */
          _requirementsRequestParameters: {
            type: Object,
            notify: true,
            computed: '_computeRequirementsRequestParameters(requirementsStateFilter, _requirementsRequestPerPage, _requirementsRequestCurrentPage)'
          },
          /**
           * Defines how many requirements are loaded per page.
           * TODO: recalculate when resizing the window.
           */
          _requirementsRequestPerPage: {
            type: Number,
            value: 10
          },
          /**
           * Stores the current page number.
           */
          _requirementsRequestCurrentPage: {
            type: Number,
            value: -1
          },
          /**
           * The requirement's element to be deleted.
           */
          elem: Object,
          /**
           * Stores the requirement object that is going to be deleted, while modal dialog is shown.
           */
          requirementToDelete: Number,
          filterValue: {
            type: String,
            value: ''
          },
          /**
           * Whether any loading operation is currently active.
           */
          loading: {
            type: Boolean,
            notify: true
          },
          buttons: {
            type: Array,
            value: [],
            notify: true
          },
          list: {
            type: Boolean,
            notify: true,
            observer: "_hasEnoughItems"
          },
          repositories: {
            type: Object,
            notify: true,
            reflectToAttribute: true
          },
          _contributorsVisible: {
            type: Object,
            value: []
          }
        },

        observers: [
          'manageSelReq(selectedRequirements.splices)',
          '_requirementsRequestParametersUpdated(_requirementsRequestParameters)',
          '_dataChanged(data.requirementId)',
          '_routeChanged(route)',
          '_categoryIdChanged(categoryId)'
        ],

        attached: function() {
          // load localized messages
          this.loadResources(this.resolveUrl('../../locales/locales.json'));
        },

        _dataChanged: function(requirementId) {
          if (requirementId) {
            /*
            // open the requirement
            var requirementNode = this.$$('#requirement' + requirementId);
            if (requirementNode) {
              requirementNode.querySelector('iron-collapse').show();
              // load comments
              requirementNode.querySelector('comments-list').load();
              // load attachments
              requirementNode.querySelector("file-gallery").loadIcons();
            } else {
              //TODO: wait till loading completes and try again
            }
            */
          }
        },

        _routeChanged: function(route) {
          if ((route.path === '') || (route.path === '/')) {
            //TODO: reset open requirements
          }
        },

        _hasEnoughItems: function () {
          if (!this.viewOption !== 'list') {
            var n = Math.floor((window.innerWidth - 300) / 300);
            var free = (window.innerWidth - 300) - n * (300 + 20);
            this.style.paddingLeft = "" + free / 2 + "px";
          } else {
            this.style.paddingLeft = "0px";
          }
        },

        /**
         * Called when the requirement DOM has been stamped. Triggers the masonry layout.
         *
         * @param e
         */
        _handleGridDomChange: function(e) {
          var grid = this.$$('#grid');
          var msnry = new Masonry(grid, {
            itemSelector: '.grid-item',
            columnWidth: 110
          });
        },

        _isViewActive: function(viewOption, view) {
          return (viewOption === view);
        },

        /**
         * Computes the resource URL for the requirements request.
         */
        _computeResourceURL: function (apiBaseUrl, categoryId) {
          return apiBaseUrl + '/components/' + categoryId + '/requirements';
        },

        /**
         * Computes the parameter array for the request to the requirements resource.
         *
         * @param requirementsStateFilter {string} the requirement's state, either 'open', 'realized' or 'all'.
         */
        _computeRequirementsRequestParameters: function(requirementsStateFilter, requirementsRequestPerPage, requirementsRequestCurrentPage) {
          var parameters = new Object();
          parameters.per_page = requirementsRequestPerPage;
          parameters.page = requirementsRequestCurrentPage;
          // better check this type as it's a public property of the element
          if (requirementsStateFilter === 'open') {
            parameters.state = 'open';
          } else if (requirementsStateFilter === 'realized') {
            parameters.state = 'realized';
          } else if (requirementsStateFilter === 'all') {
            parameters.state = 'all';
          }

          return parameters;
        },

        /**
         * Called when some of the requirements request parameters change, e.g. the state is set from 'open' to
         * 'realized'. In that case, we need to refresh the requirements list.
         *
         * @param _requirementsRequestParameters {array} the requirements request parameter.
         */
        _requirementsRequestParametersUpdated: function(_requirementsRequestParameters) {
          //this.load();
        },

        refresh: function() {
          this.$.requirementsRequest.generateRequest();
        },

        manageSelReq: function(selReq) {
          if (this.selectedRequirements.length !== 0) {
            this.$.bottomToolbar.hidden = false;
          }
        },

        showRepoSearchResults: function() {
          this.repositories = this.searchRepositories.items;
        },

        downloadRequirements: function(e) {
          var selReq = [];
          for (var i=0; i < this.selectedRequirements.length; i++) {
            for (var j=0; j < this.requirements.length; j++) {
              if (parseInt(this.selectedRequirements[i]) === this.requirements[j].id) {
                selReq.push(this.requirements[j]);
              }
            }
          }

          //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
          var arrData = typeof selReq != 'object' ? JSON.parse(selReq) : selReq;

          var CSV = '';
          //Set Report title in first row or line

          CSV += 'Requirements of ' + arrData[0].components[0].name + '\r\n\n';

          var row = 'TITLE, DESCRIPTION, CREATION DATE, CREATOR, DEVELOPERS, FOLLOWERS, CATEGORY';

          //append Label row with line break
          CSV += row + '\r\n';

          //1st loop is to extract each row
          for (var i = 0; i < arrData.length; i++) {
            var row = '';

            row += '"' + arrData[i].title + '",';
            row += '"' + arrData[i].description + '",';
            row += '"' + arrData[i].creation_time + '",';
            row += '"' + arrData[i].creator.userName + '",';
            row += '"' + arrData[i].developers.length + '",';
            row += '"' + arrData[i].followers.length + '",';
            row += '"' + arrData[i].components[0].name + '",';

            row.slice(0, row.length - 1);

            //add a line break after each row
            CSV += row + '\r\n';
          }

          if (CSV == '') {
            //TODO: display toast
            alert('Invalid data');
            return;
          }

          //Generate a file name
          var fileName = arrData[0].components[0].name + '_';
          //this will remove the blank-spaces from the title and replace it with an underscore
          fileName += 'Requirements'.replace(/ /g, '_');

          //Initialize file format you want csv or xls
          var uri = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);

          //this trick will generate a temp <a /> tag
          var link = document.createElement('a');
          link.href = uri;

          //set the visibility hidden so it will not effect on your web-layout
          link.style = 'visibility:hidden';
          link.download = fileName + '.csv';

          //this part will append the anchor tag and remove it after automatic click
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },

        postGridComment: function(e) {
          var reqId = e.currentTarget.parentNode.parentNode.querySelector('comments-list').requirementId;
          var request = this.$.postCommentRequest;
          var message = e.currentTarget.value;
          request.body = JSON.stringify({
            "requirementId": reqId,
            "message": message
          });
          request.generateRequest();

          e.currentTarget.value = '';
          e.currentTarget.parentNode.parentNode.querySelector('.comments-input').value = null;
        },

        showGithubRepos: function(e) {
          this.$.reposContainer.open();
          var el = e.currentTarget;
          var tag = 'PAPER-MATERIAL';
          var element;

          while (el.parentNode) {
            el = el.parentNode;
            if (el.tagName === tag)
              element = el;
          }
          this.selReq = element.id;
        },

        onRepoDialogClosed: function (e) {
          if(e.detail.confirmed) {
            var title = "";
            var desc = "";
            for (var i=0; i < this.requirements.length; i++) {
              if (this.requirements[i].id == this.selReq) {
                title = this.requirements[i].title;
                desc = this.requirements[i].description;
              }
              break;
            }
            var req = this.$.postIssueGit;
            req.url = 'https://api.github.com/repos/' + this.repositories[parseInt(this.$.selRepo.selected)].full_name + '/issues';
            req.body = JSON.stringify({
              "title": title,
              "body": desc
            });
            req.generateRequest();
          } else {
            this.$.selRepo.selected = '0';
            this.selReq = null;
          }
        },

        _handleAddCommentTap: function(e) {
          var currentReqId = e.model.req.id;
          var request = this.$.postCommentRequest;
          var message;
          if (this.viewOption === 'list') {
            message = this.$$('#comment' + currentReqId).value;
          } else {
            message = this.$.commentsDialog.querySelector('paper-input').value;
          }
          if (message != null && (message !== '')) {
            request.body = JSON.stringify({
              "requirementId": parseInt(currentReqId),
              "message": message
            });
            request.generateRequest();
          } else {
            this.$.toast.text = this.localize('commentNoEmpty');
            this.$.toast.open();
          }
          var message;
          if (this.viewOption === 'list') {
            this.$$('#comment' + currentReqId).value = '';
          } else {
            this.$.commentsDialog.querySelector('paper-input').value = '';
          }
          this.$$('#comment' + currentReqId).value = null;
        },

        _handleCommentResponse: function(data) {
          var requirementId = data.detail.response.requirementId;
          if (this.viewOption === 'list') {
            this.$$('#comments' + requirementId).querySelector('comments-list').refresh();
          } else {
            // reload comments in grid view
            this.$.commentsDialog.querySelector('comments-list').refresh();
          }

        },

        showSendButton: function(e) {
          var fab = e.currentTarget.parentNode.querySelector('#fab');
          var message;
          if (this.viewOption === 'list') {
            message = this.$$('#comment' + requirementId).value;
          } else {
            message = this.$.commentsDialog.querySelector('paper-input').value;
          }
          if (message) {
            fab.style.display = 'block';
          } else {
            fab.style.display = 'none';
          }
        },

        _handleCommentInput: function(e) {
          this.$$('#sendComment' + e.model.req.id).hidden = false;
        },

        errorHandler: function (e, detail) {
          this.$.toast.text = detail.error.message;
          this.$.toast.open();
        },

        handleResponseGithubIssue: function() {
          this.$.toast.text = 'Issue posted to Github';
          this.$.toast.open();
        },

        closeBottomToolbar: function() {
          this.$.bottomToolbar.hidden = true;
          //TODO: fix unselection as soon as we use iron-list
          for (var i=0; i < this.selectedRequirements.length; i++) {
            this.$$('#checkbox' + this.selectedRequirements[i]).checked = false;
            //this.$$('#checkbox' + this.selectedRequirements[i]).hidden = true;
          }
          this.selectedRequirements = [];
        },

        handleResponseEditReq: function(data) {
          if (data != null) {
            this.toastFeedback = this.localize('reqEditSucc');
            this.refresh();
          }
          this.$.toast.open();
        },

        openCommentsDialog: function(e) {
          this.$.commentsDialog.querySelector("comments-list").requirementId = e.currentTarget.atr;
          this.$.commentsDialog.querySelector("comments-list").refresh();
          this.$.commentsDialog.open();
        },

        deleteLeftoverComment: function(e) {
          this.$.commentsDialog.querySelector("comments-list").comments = [];
        },

        searchFilter: function (val) {
          return function (item) {
            if (!val) {
              return true;
            }
            //return (item.name && ~item.name.toLowerCase().indexOf(val.toLowerCase()));
            return (item.title && ~item.title.toLowerCase().indexOf(val.toLowerCase())) || (item.description && ~item.description.toLowerCase().indexOf(val.toLowerCase()));
          };
        },

        _handleCommentEnter: function (e) {
          //TODO: refactor the code
          // keyCode 13 is Enter
          if (e.keyCode === 13) {
            // check if the Enter key was pressed...
            if (!e.ctrlKey) {
              if (this.viewOption === 'list') {
                this._handleAddCommentTap(e);
              } else {
                this.postGridComment(e);
              }
              e.preventDefault();
            } else {
              e.currentTarget.value += "<br/>";
            }
          }
        },

        searchGithubRepo: function (e) {
          if (e.keyCode === 13) {
            if (!e.ctrlKey) {
              var req = this.$.getSearchGit;
              req.url = "https://api.github.com/search/repositories?q=" + encodeURIComponent(this.$.searchGithubRepo.value);
              req.generateRequest();
              e.preventDefault();
            }
          }
        },

        dragRequirement: function() {
        },

        /**
         * Handles the iron-ajax response for following/unfollowing requirements,
         * shows toast message.
         *
         * @param data
         * @private
         */
        _handleFollowResponse: function(e) {
          var status = e.detail.status;

          if (status === 200) {
            this.toastFeedback = this.localize('fdbUnfollowReq');
          } else if (status === 201) {
            this.toastFeedback = this.localize('fdbFollowReq');
          } else {
            //TODO: add i18n
            this.toastFeedback = 'error';
          }

          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Handles the iron-ajax response for posting/deleting users to/from a resoure,
         * shows toast message.
         *
         * @param data
         * @private
         */
        _handleUserInResourceResponse: function(e) {
          var method = e.target.method;

          if (method === 'DELETE') {
            this.toastFeedback = this.localize('fdbUndevelopReq');
          } else if (method === 'POST') {
            this.toastFeedback = this.localize('fdbDevelopReq');
          } else {
            //TODO: add i18n
            this.toastFeedback = 'error';
          }

          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Toggles the 'realized' property of a requirement on the server. If the requirement was not realized yet,
         * the current timestamp is sent to the server. Otherwise, the realized property is reset.
         *
         * @param requirement {object} the requirements object.
         */
        _toggleRealized: function(requirement) {
          var request = this.$.updateRequirementRequest;
          request.url = this._apiBaseUrl + '/requirements/' + requirement.id + '/realized';

          if (requirement.hasOwnProperty('realized')) {
            // unrealize it
            request.method = 'DELETE';
          } else {
            // realize it
            request.method = 'POST';
          }

          // fire
          request.generateRequest();
        },

        /**
         * Handles the iron-ajax response for updating requirements, shows toast message.
         *
         * @param e
         * @private
         */
        _handleUpdateRequirementResponse: function(e) {
          if (e != null) {
            this.toastFeedback = this.localize('reqEditSucc');
          }

          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Handles the delete modal dialog closed event.
         *
         * @param e
         * @private
         */
        _handleDeleteRequirement: function(e) {
          if (e.detail.confirmed) {
            var requirement = this.requirementToDelete;
            var request = this.$.deleteRequirementRequest;
            request.url = this._apiBaseUrl + '/requirements/' + requirement.id;

            request.generateRequest();
          }
        },

        /**
         * Handles the result of the DELETE requirement request.
         *
         * @param e
         * @private
         */
        _handleDeleteRequirementResponse: function(e) {
          //TODO: check result

          this.toastFeedback = this.localize('reqDelSucc');
          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Updates the lead developer for a specified requirement on the server. If the user is already lead developer,
         * then the user 1 (anonymous) is becoming lead developer, otherwise the user takes this role.
         *
         * @param requirement a requirement object.
         * @private
         */
        _toggleLeadDeveloper: function(requirement) {
          var request = this.$.updateRequirementRequest;
          request.url = this._apiBaseUrl + '/requirements/' + requirement.id + '/leaddevelopers';

          if (requirement.hasOwnProperty('leadDeveloper') && (requirement.leadDeveloper.id === this.currentUser.id)) {
            request.method = 'DELETE';
          } else {
            request.method = 'POST';
          }

          // fire
          request.generateRequest();
        },

        /**
         * Shows the editing form of the specified requirement.
         *
         * @param requirementId
         * @private
         */
        _editRequirement: function(requirementId) {
          //hide card elements
          this.$$('#requirementBody' + requirementId).style.display = 'none';
          this.$$('#comments' + requirementId).style.display = 'none';
          this.$$('#description' + requirementId).style.display = 'none';
          //show form elements
          this.$$('#edit' + requirementId).style.display = 'block';
        },

        /**
         * Saves the edited requirement on the server.
         *
         * @param e
         * @private
         */
        _handleSaveEditTap: function(e) {
          // refactoring: formerly known as saveEditReq

          var model = e.model;

          //TODO: use proper ids!
          var title = e.currentTarget.parentNode.querySelector('PAPER-INPUT').value;
          var description = e.currentTarget.parentNode.querySelector('PAPER-TEXTAREA').value;

          var request = this.$.postUpdateRequirement;
          //TODO: check if this is not harmful code when requirement belongs to multiple categories
          var categories = [{id: this.categoryId}];
          request.url = this._apiBaseUrl + "/requirements/" + model.req.id;

          if (title != '' && description != '') {
            request.body = JSON.stringify({
              "id": model.req.id,
              "title": title,
              "description": description,
              "projectId": this.projectId,
              "components": categories
            });
            request.generateRequest();

            // revert the look
            this._handleCancelEditTap(e);

          } else {
            this.$.toast.text = this.localize('fieldsNotEmptyReq');
            this.$.toast.open();
          }
        },

        /**
         * Cancels editing a requirement by hiding the form.
         *
         * @param e
         * @private
         */
        _handleCancelEditTap: function(e) {
          // refactoring: formerly known as cancelRequirement
          var requirementId = e.model.req.id;

          // show form elements
          this.$$('#edit' + requirementId).style.display = 'none';

          // show card elements
          this.$$('#requirementBody' + requirementId).style.display = 'block';
          this.$$('#comments' + requirementId).style.display = 'block';
          this.$$('#description' + requirementId).style.display = 'block';
        },

        /**
         * Reset the view when the category id changes.
         *
         * @param categoryId
         * @private
         */
        _categoryIdChanged: function(categoryId) {
          this.resetView();
        },

        resetView: function() {
          //TODO: this seems to be a rather naive approach...
          this.requirements = [];
        },

        _handleRequirementsResponse: function(e) {
          var requirementsResponse = e.detail.response;

          requirementsResponse.forEach(function(requirementItem) {
            var requirement = {"opened": false, "requirementItem": requirementItem};
            this.push('requirements', requirement);
          }.bind(this));

          this.$.scrollThreshold.clearTriggers();
        },

        _loadMoreData: function() {
          this._requirementsRequestCurrentPage++;
          this.$.requirementsRequest.generateRequest();
        },

        _handleIronResize: function() {
          this.$.requirementsList.notifyResize();
        },

        /**
         * A fix for the issue that paper-dropdown within an iron-list disappear behind the next list item.
         * Check https://github.com/PolymerElements/iron-list/issues/242 for the issue.
         *
         * @param e
         * @param detail
         * @private
         */
        _handleMenuOpen: function(e, detail) {
          detail.style.zIndex = 1;
        },

        _handleMenuClose: function(e, detail) {
          detail.style.zIndex = 0;
        },

        _handleShowToast: function(e, detail) {
          this.toastFeedback = detail;
          this.$.toast.open();
        }

      });

    })();
  </script>

</dom-module>
