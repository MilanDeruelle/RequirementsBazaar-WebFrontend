<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/openidconnect-signin/openidconnect-signin-aware.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../comments-list/comments-list.html">
<link rel="import" href="../file-gallery/file-gallery.html">
<link rel="import" href="../../src/shared-styles.html">
<link rel="import" href="../../src/config-behavior.html">

<script src="../../bower_components/masonry/dist/masonry.pkgd.min.js"></script>

<dom-module id="requirements-list">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
      }

      paper-card {
        max-width: 300px;
        min-width: 300px;
      }

      .time {
        display: inline-flex;
        font-style: italic;
        float: right;
        padding-right: 5px;
      }

      paper-material {
        border-radius: 2px;
        /*height: 100%;*/
        width: 100%;
        box-sizing: border-box;
        margin: 5px;
        padding: 0 16px 0 16px;
        max-width: 800px;
        background: white;
        cursor: pointer;
        display: block;
      }

      .inactive {
        color: #838383;
      }

      .colored {
        color: var(--paper-orange-500);
      }

      paper-toolbar {
        background: none;
        color: #000000;
        height: 75px;
        right: 15px;
      }

      paper-toolbar > div.title {
        margin-left: 0px !important;
        margin-bottom: 10px;
      }

      paper-toolbar .bottom {
        font-size: small;
        font-weight: normal;
        padding: 16px;
      }

      paper-toolbar {
        --paper-toolbar: {
          font-weight: bold;
          font-size: large;
        };
      }

      paper-material > div {
        margin-bottom: 10px;
      }

      h3 {
        margin-bottom: 10px;
      }

      paper-fab {
        --paper-fab-background: var(--default-primary-color);
      }

      paper-toast {
        z-index: 105;
      }

      .flex-horizontal {
        @apply(--layout-horizontal);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      .flex-end-align {
        margin-top: auto;
        margin-bottom: auto;
      }

      .req-icons {
        position: relative;
        float: right;
      }

      .editForm {
        display: none;
      }

      paper-button {
        /*display: none;*/
        float: right;
        margin: 20px;
      }

      .hide {
        display: none;
      }

      paper-checkbox{
        display: none;
      }

      #bottomToolbar {
        position: fixed;
        bottom: 50px;
        left: 10px;
        z-index: 105;
        width: auto;
        padding: 10px;
      }

      #grid .starIcon {
        float: right;
        margin: 20px;
      }

      .grid-item {
        margin: 5px;
        margin-bottom: 10px;
      }

      .line {
        background: #c6c6c6 no-repeat scroll center;
        margin-top: -20px;
        /*margin-bottom: 10px;*/
        width: 95%;
        height: 1px;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/requirements/:requirementId"
      data="{{data}}"></app-route>

    <openidconnect-signin-aware is-authorized="{{authorized}}"
                                on-openidconnect-signin-aware-success="_handleSigninSuccess"
                                on-openidconnect-signin-aware-signed-out="_handleSignedOut"></openidconnect-signin-aware>

    <iron-signals on-iron-signal-language-changed="_handleLanguageChanged"></iron-signals>

    <iron-ajax
      id="requirementsRequest"
      loading="{{loading}}"
      url="[[_resourceURL]]"
      last-response="{{requirements}}"
      headers="[[authHeader]]"
      params="[[_requirementsRequestParameters]]"
      auto></iron-ajax>

    <iron-ajax
      id="postUpdateRequirement"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="PUT"
      headers="[[authHeader]]"
      on-response="handleResponseEditReq"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="updateRequirementRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="PUT"
      headers="[[authHeader]]"
      on-response="_handleUpdateRequirementResponse"
      on-error="errorHandler"></iron-ajax>


    <iron-ajax
      id="postDeleteRequirement"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="DELETE"
      headers="[[authHeader]]"
      on-response="handleResponseDeleteReq"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="deleteRequirementRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      method="DELETE"
      headers="[[authHeader]]"
      on-response="_handleDeleteRequirementResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="followRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      headers="[[authHeader]]"
      on-response="_handleFollowResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="userInResourceRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      headers="[[authHeader]]"
      on-response="_handleUserInResourceResponse"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="starRequest"
      loading="{{loading}}"
      handle-as="json"
      content-type="application/json"
      headers="[[authHeader]]"
      on-response="load"
      on-error="errorHandler"></iron-ajax>

    <iron-ajax
      id="postCommentRequest"
      loading="{{loading}}"
      handle-as="json"
      url="{{_apiBaseUrl}}/comments"
      content-type="application/json"
      method="POST"
      headers="[[authHeader]]"
      on-response="handleResponseComment"
      last-response="{{postResponse}}"
      on-error="errorHandler"></iron-ajax>

        <!--<iron-ajax-->
                <!--id="postIssueGit"-->
                <!--handle-as="json"-->
                <!--content-type="application/json"-->
                <!--params='{"access_token": ""}'-->
                <!--method="POST"-->
                <!--on-response="handleResponseGithubIssue"-->
                <!--on-error="errorHandler"></iron-ajax>-->

        <!--<iron-ajax-->
                <!--id="getSearchGit"-->
                <!--handle-as="json"-->
                <!--content-type="application/json"-->
                <!--method="GET"-->
                <!--last-response="{{searchRepositories}}"-->
                <!--on-response="showRepoSearchResults"-->
                <!--on-error="errorHandler"></iron-ajax>-->


    <!-- GRID VIEW -->

    <template is="dom-if" if="{{_isViewActive(viewOption, 'grid')}}" restamp>
      <div id="grid">
        <template is="dom-repeat" items="{{requirements}}" as="req" filter="{{searchFilter(filterValue)}}" on-dom-change="_handleGridDomChange">

          <div class="grid-item">
            <paper-card heading="{{req.title}}" elevation="2" id="[[req.id]]">
              <!--<paper-checkbox></paper-checkbox>-->
              <div style="display:inline-flex; padding-left: 16px;"><span>[[localize('by')]] <req-user user="[[req.creator]]" normal-view></req-user></span></div>
              <relative-time class="time" datetime$="[[req.creation_time]]"></relative-time>
              <div class="card-content" class="truncate">{{req.description}}</div>
              <div class="card-actions">
                <paper-button on-tap="openCommentsDialog" atr="[[req.id]]">
                  <iron-icon icon="editor:mode-comment"></iron-icon>
                </paper-button>
                <span class="starIcon">
                  <paper-icon-button icon="[[_calculateStarIcon(req.userVoted, authorized)]]"
                                     class$="[[_calculateStarClass(req.userVoted, authorized)]]"
                                     on-tap="_handleStarTap"
                                     disabled="[[!authorized]]"></paper-icon-button>
                  [[req.upVotes]]
                </span>
              </div>
            </paper-card>
          </div>

        </template>
      </div>
    </template>

    <!-- LIST VIEW -->

    <template is="dom-if" if="{{_isViewActive(viewOption, 'list')}}">

      <template is="dom-repeat" items="{{requirements}}" as="req" filter="{{searchFilter(filterValue)}}" initial-count="4">
        <div class="layout vertical center">

          <paper-material class="req" id="requirement[[req.id]]" on-mouseover="showOnHover" on-mouseout="hideOnOut">
            <div class="reqbody" id$="requirementBody{{req.id}}">

              <div class="req-icons layout horizontal center">
                <paper-checkbox id="checkbox[[req.id]]" on-change="_handleCheckboxChange"></paper-checkbox>
                <paper-icon-button icon="[[_calculateStarIcon(req.userVoted, authorized)]]"
                                   class$="[[_calculateStarClass(req.userVoted, authorized)]]"
                                   on-tap="_handleStarTap"
                                   disabled="[[!authorized]]"></paper-icon-button>
                <div>[[req.upVotes]]</div>

                <paper-menu-button horizontal-align="right" vertical-align="top" hidden="[[!authorized]]" on-iron-select="_handleRequirementMenuSelect">
                  <paper-icon-button icon="more-vert" class="dropdown-trigger" alt="menu"></paper-icon-button>
                  <paper-menu class="dropdown-content">
                    <!--<paper-item on-tap="showGithubRepos">Post as Github Issue</paper-item>-->
                    <paper-item value="toggleContributors">[[localize('showContributors')]]</paper-item>
                    <paper-item value="follow" hidden$="[[req.realized]]">[[_calculateMessageBasedOnUserInArray(req.followers, 'followRequirement', 'unfollowRequirement')]]</paper-item>
                    <paper-item value="develop" hidden$="[[req.realized]]">[[_calculateMessageBasedOnUserInArray(req.developers, 'developRequirement', 'undevelopRequirement')]]</paper-item>
                    <paper-item value="becomeLeadDeveloper" hidden$="[[req.realized]]">[[_calculateLeadDeveloperLocalization(req.leadDeveloperId)]]</paper-item>
                    <paper-item value="edit" hidden$="[[req.realized]]">[[localize('editRequirement')]]</paper-item>
                    <paper-item value="realize">[[_calculateRealizeMessage(req.realized)]]</paper-item>
                    <paper-item value="delete">[[localize('deleteRequirement')]]</paper-item>
                  </paper-menu>
                </paper-menu-button>

              </div>

              <paper-toolbar class="title" on-tap="_handleRequirementTap">
                <div class="title" style="overflow: visible;">[[req.title]]</div>
                <div class="bottom fit" style="margin-top:20px;">
                  <relative-time datetime$="[[req.creation_time]]"></relative-time>
                  [[localize('by')]]
                  <req-user user="[[req.creator]]" normal-view></req-user>
                </div>
              </paper-toolbar>

            </div>

            <div class="line"></div>

            <div id$="contributors[[req.id]]" hidden>
              <div>[[localize('creator')]]: <req-user user="[[req.creator]]" full-view></req-user></div>
              <div>[[localize('leadDeveloper')]]: <req-user user="[[req.leadDeveloper]]" full-view></req-user></div>
              <div>[[localize('developers')]]:
                <template is="dom-repeat" items="{{req.developers}}" as="developer">
                  <div style="display:inline-block">
                    <req-user user="[[developer]]" mini></req-user>
                    <paper-tooltip>{{developer.userName}}</paper-tooltip>
                  </div>
                </template>
              </div>
              <div>[[localize('followers')]]:
                <template is="dom-repeat" items="{{req.followers}}" as="foll">
                  <div style="display:inline-block">
                    <req-user user="[[foll]]" mini></req-user>
                    <paper-tooltip>{{foll.userName}}</paper-tooltip>
                  </div>
                </template>
              </div>

              <div class="line" style="margin-top: 10px;"></div>

            </div>

            <div class="description inactive" inner-h-t-m-l="{{validateUrl(req.description)}}" id$="description[[req.id]]"></div>

            <div class="comments" id$="comments{{req.id}}">

              <iron-collapse>
                <file-gallery attachments="{{req.attachments}}"></file-gallery>
                <h4 style="margin:0px;padding:10px 0px 10px 0px;">[[localize('comments')]]</h4>
                <comments-list requirement-id="[[req.id]]" data-a="[[req.id]]" base-href="{{_apiBaseUrl}}"></comments-list>
                <div class="container flex-horizontal" id="[[req.id]]" hidden="[[!authorized]]">
                  <paper-input id="comment[[req.id]]" is="iron-input" on-input="_handleCommentInput" label="[[localize('addComment')]]" value="{{newComment}}" class="flexchild" on-keydown="_handleCommentEnter">
                    <!--<emoji-selector suffix></emoji-selector>-->
                  </paper-input>
                  <paper-icon-button id$="sendComment[[req.id]]" mini icon="send" class="flex-end-align" on-tap="_handleAddCommentTap" hidden></paper-icon-button>
                </div>
              </iron-collapse>

            </div>

            <div class="editForm" id$="edit{{req.id}}">

              <paper-input class="editTitle title" value="{{req.title}}"></paper-input>
              <paper-textarea value="{{req.description}}"></paper-textarea>
              <paper-button raised on-tap="_handleSaveEditTap" data-args="[[req.title]]">[[localize('save')]]</paper-button>
              <paper-button raised on-tap="_handleCancelEditTap" data-args="[[req.title]]">[[localize('cancel')]]</paper-button>

            </div>

          </paper-material>

        </div>
      </template>

    </template>

    <!-- Dialog for GitHub export functionality: -->

    <paper-dialog id="reposContainer" on-iron-overlay-closed="onRepoDialogClosed">
      <h2>Your Github Repositories</h2>
      <paper-dialog-scrollable>
        <paper-input id="searchGithubRepo" label="Search a Github Repository" on-keydown="searchGithubRepo">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
        <iron-selector id="selRepo" selected="0">
          <template is="dom-repeat" items$="{{repositories}}" id="repoElements">
            <paper-item>
              <paper-item-body two-line>
                <div>{{item.name}}</div>
                <div secondary>{{item.description}}</div>
              </paper-item-body>
            </paper-item>
          </template>
        </iron-selector>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>POST</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for confirming the deletion of a requirement: -->

    <paper-dialog id="modal" modal on-iron-overlay-closed="_handleDeleteRequirement" entry-animation="fade-in-animation"
                  exit-animation="fade-out-animation">
      <h2>[[localize('deleteRequirement')]]?</h2>
      <p>[[localize('deleteRequirementDesc')]]</p>
      <div class="buttons">
        <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
        <paper-button dialog-confirm autofocus>[[localize('delete')]]</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for showing comments in the grid view: -->

    <paper-dialog id="commentsDialog" on-iron-overlay-closed="deleteLeftoverComment" entry-animation="fade-in-animation" exit-animation="fade-out-animation"
                  style="min-width:40%; max-width:85%; top:100px; max-height: 80%; overflow:scroll;">
      <h2>[[localize('comments')]]</h2>
      <p style="max-height: 80%;">
        <comments-list base-href="{{_apiBaseUrl}}"></comments-list>
      <div class="container flex-horizontal" hidden="[[!authorized]]">
        <paper-input is="iron-input" on-input="showSendButton" label="[[localize('addComment')]]" value="{{newComment}}" class="flexchild comments-input" on-keydown="_handleCommentEnter">
        </paper-input>
        <paper-fab id="fab" mini icon="send" class="flex-end-align" on-tap="postGridComment"></paper-fab>
      </div>
      </p>
    </paper-dialog>

    <!-- Floating toolbar for selected requirements: -->

    <paper-material elevation="5" id="bottomToolbar" hidden>
      <span>{{selectedRequirements.length}} Requirements selected.</span>
      <paper-icon-button icon="file-download" on-tap="downloadRequirements"></paper-icon-button>
      <paper-icon-button icon="close" on-tap="closeBottomToolbar"></paper-icon-button>
    </paper-material>

    <!-- Toast for toast notifications: -->

    <paper-toast id="toast" text="[[feedback]]"></paper-toast>

  </template>

  <script>
    (function () {
      //'use strict';

      Polymer({
        is: 'requirements-list',
        listeners: {
          //'change': 'addToSelectedReq'
        },

        behaviors: [
          Polymer.AppLocalizeBehavior,
          ConfigBehavior
        ],

        properties: {
          route: {
            type: Object,
            notify: true
          },
          categoryId: {
            type: Number
          },
          /**
           * Whether to show 'open' or 'realized' requirements.
           */
          requirementsStateFilter: {
            type: String,
            notify: true,
            value: 'open'
          },
          viewOption: {
            type: String,
            value: 'list'
          },
          _resourceURL: {
            type: String,
            computed: '_computeResourceURL(_apiBaseUrl, categoryId)'
          },
          requirements: {
            type: Array,
            notify: true
          },
          selectedRequirements: {
            type: Array,
            value: [],
            notify: true
          },
          newComment: {
            type: String
          },
          postUrl: String,
          body: Object,
          postResponse: Object,
          feedback: String,
          header: {
            type:Object,
            notify: true
          },
          /**
           * The parameters for the request to the requirements resource.
           */
          _requirementsRequestParameters: {
            type:Object,
            notify: true,
            computed: '_computeRequirementsRequestParameters(requirementsStateFilter)'
          },
          /**
           * The requirement's element to be deleted.
           */
          elem: Object,
          /**
           * Stores the requirement object that is going to be deleted, while modal dialog is shown.
           */
          requirementToDelete: Number,
          filterValue: {
            type: String,
            value: ''
          },
          /**
           * Whether any loading operation is currently active.
           */
          loading: {
            type: Boolean,
            notify: true
          },
          buttons: {
            type: Array,
            value: [],
            notify: true
          },
          list: {
            type: Boolean,
            notify: true,
            observer: "_hasEnoughItems"
          },
          repositories: {
            type: Object,
            notify: true,
            reflectToAttribute: true
          },
          _contributorsVisible: {
            type: Object,
            value: []
          }
        },

        observers: [
          'manageSelReq(selectedRequirements.splices)',
          '_requirementsRequestParametersUpdated(_requirementsRequestParameters)',
          '_dataChanged(data.requirementId)',
          '_routeChanged(route)',
          '_categoryIdChanged(categoryId)'
        ],

        attached: function() {
          // load localized messages
          this.loadResources(this.resolveUrl('../../locales/locales.json'));
        },

        _dataChanged: function(requirementId) {
          if (requirementId) {
            /*
            // open the requirement
            var requirementNode = this.$$('#requirement' + requirementId);
            if (requirementNode) {
              requirementNode.querySelector('iron-collapse').show();
              // load comments
              requirementNode.querySelector('comments-list').load();
              // load attachments
              requirementNode.querySelector("file-gallery").loadIcons();
            } else {
              //TODO: wait till loading completes and try again
            }
            */
          }
        },

        _routeChanged: function(route) {
          if ((route.path === '') || (route.path === '/')) {
            //TODO: reset open requirements
          }
        },

        _hasEnoughItems: function () {
          if (!this.viewOption !== 'list') {
            var n = Math.floor((window.innerWidth - 300) / 300);
            var free = (window.innerWidth - 300) - n * (300 + 20);
            this.style.paddingLeft = "" + free / 2 + "px";
          } else {
            this.style.paddingLeft = "0px";
          }
        },

        /**
         * Called when the requirement DOM has been stamped. Triggers the masonry layout.
         *
         * @param e
         */
        _handleGridDomChange: function(e) {
          var grid = this.$$('#grid');
          var msnry = new Masonry(grid, {
            itemSelector: '.grid-item',
            columnWidth: 110
          });
        },

        _isViewActive: function(viewOption, view) {
          return (viewOption === view);
        },

        /**
         * Computes the resource URL for the requirements request.
         */
        _computeResourceURL: function (apiBaseUrl, categoryId) {
          return apiBaseUrl + '/components/' + categoryId + '/requirements';
        },

        /**
         * Computes the parameter array for the request to the requirements resource.
         *
         * @param requirementsStateFilter {string} the requirement's state, either 'open', 'realized' or 'all'.
         */
        _computeRequirementsRequestParameters: function(requirementsStateFilter) {
          var parameters = new Object();
          parameters.per_page = 60;
          // better check this type as it's a public property of the element
          if (requirementsStateFilter === 'open') {
            parameters.state = 'open';
          } else if (requirementsStateFilter === 'realized') {
            parameters.state = 'realized';
          } else if (requirementsStateFilter === 'all') {
            parameters.state = 'all';
          }

          return parameters;
        },

        /**
         * Called when some of the requirements request parameters change, e.g. the state is set from 'open' to
         * 'realized'. In that case, we need to refresh the requirements list.
         *
         * @param _requirementsRequestParameters {array} the requirements request parameter.
         */
        _requirementsRequestParametersUpdated: function(_requirementsRequestParameters) {
          //this.load();
        },

        refresh: function() {
          this.$.requirementsRequest.generateRequest();
        },

        showOnHover: function(e) {
          var chb = e.currentTarget.querySelector("paper-checkbox");
          chb.style.display = "block";
        },

        hideOnOut: function (e) {
          var chb = e.currentTarget.querySelector("paper-checkbox");
          if (!chb.checked) {
            chb.style.display = "none";
          }
        },

        manageSelReq: function(selReq) {
          if (this.selectedRequirements.length !== 0) {
            this.$.bottomToolbar.hidden = false;
          }
        },

        showRepoSearchResults: function() {
          this.repositories = this.searchRepositories.items;
        },

        _handleCheckboxChange: function(e) {
          var requirementId = e.model.req.id;
          if (e.target.checked) {
            this.push('selectedRequirements', requirementId);
          } else {
            var index = this.selectedRequirements.indexOf(requirementId);
            if (index > -1) {
              this.splice('selectedRequirements', index, 1);
            }
          }
          this.$.bottomToolbar.hidden = (this.selectedRequirements.length === 0)
        },

        downloadRequirements: function(e) {
          var selReq = [];
          for (var i=0; i < this.selectedRequirements.length; i++) {
            for (var j=0; j < this.requirements.length; j++) {
              if (parseInt(this.selectedRequirements[i]) === this.requirements[j].id) {
                selReq.push(this.requirements[j]);
              }
            }
          }

          //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
          var arrData = typeof selReq != 'object' ? JSON.parse(selReq) : selReq;

          var CSV = '';
          //Set Report title in first row or line

          CSV += 'Requirements of ' + arrData[0].components[0].name + '\r\n\n';

          var row = 'TITLE, DESCRIPTION, CREATION DATE, CREATOR, DEVELOPERS, FOLLOWERS, CATEGORY';

          //append Label row with line break
          CSV += row + '\r\n';

          //1st loop is to extract each row
          for (var i = 0; i < arrData.length; i++) {
            var row = '';

            row += '"' + arrData[i].title + '",';
            row += '"' + arrData[i].description + '",';
            row += '"' + arrData[i].creation_time + '",';
            row += '"' + arrData[i].creator.userName + '",';
            row += '"' + arrData[i].developers.length + '",';
            row += '"' + arrData[i].followers.length + '",';
            row += '"' + arrData[i].components[0].name + '",';

            row.slice(0, row.length - 1);

            //add a line break after each row
            CSV += row + '\r\n';
          }

          if (CSV == '') {
            //TODO: display toast
            alert('Invalid data');
            return;
          }

          //Generate a file name
          var fileName = arrData[0].components[0].name + '_';
          //this will remove the blank-spaces from the title and replace it with an underscore
          fileName += 'Requirements'.replace(/ /g, '_');

          //Initialize file format you want csv or xls
          var uri = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);

          //this trick will generate a temp <a /> tag
          var link = document.createElement('a');
          link.href = uri;

          //set the visibility hidden so it will not effect on your web-layout
          link.style = 'visibility:hidden';
          link.download = fileName + '.csv';

          //this part will append the anchor tag and remove it after automatic click
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },

        postGridComment: function(e) {
          var reqId = e.currentTarget.parentNode.parentNode.querySelector('comments-list').requirementId;
          var request = this.$.postCommentRequest;
          request.body = JSON.stringify({
            "requirementId": reqId,
            "message": this.newComment
          });
          request.generateRequest();

          this.newComment = '';
          e.currentTarget.parentNode.parentNode.querySelector('.comments-input').value = null;
        },

        showGithubRepos: function(e) {
          this.$.reposContainer.open();
          var el = e.currentTarget;
          var tag = 'PAPER-MATERIAL';
          var element;

          while (el.parentNode) {
            el = el.parentNode;
            if (el.tagName === tag)
              element = el;
          }
          this.selReq = element.id;
        },

        onRepoDialogClosed: function (e) {
          if(e.detail.confirmed) {
            var title = "";
            var desc = "";
            for (var i=0; i < this.requirements.length; i++) {
              if (this.requirements[i].id == this.selReq) {
                title = this.requirements[i].title;
                desc = this.requirements[i].description;
              }
              break;
            }
            var req = this.$.postIssueGit;
            req.url = 'https://api.github.com/repos/' + this.repositories[parseInt(this.$.selRepo.selected)].full_name + '/issues';
            req.body = JSON.stringify({
              "title": title,
              "body": desc
            });
            req.generateRequest();
          } else {
            this.$.selRepo.selected = '0';
            this.selReq = null;
          }
        },

        _handleAddCommentTap: function(e) {
          var currentReqId = e.model.req.id;
          var request = this.$.postCommentRequest;
          if (this.newComment != null && this.newComment != '') {
            request.body = JSON.stringify({
              "requirementId": parseInt(currentReqId),
              "message": this.newComment
            });
            request.generateRequest();
          } else {
            this.$.toast.text = this.localize('commentNoEmpty');
            this.$.toast.open();
          }
          this.newComment = '';
          this.$$('#comment' + currentReqId).value = null;
        },

        handleResponseComment: function(data) {
          var requirementId = data.detail.response.requirementId;
          if (this.viewOption === 'list') {
            this.$$('#comments' + requirementId).querySelector('comments-list').refresh();
          } else {
            //TODO: reload comments in grid view
          }

        },

        showSendButton: function(e) {
          var fab = e.currentTarget.parentNode.querySelector('#fab');
          if (this.newComment) {
            fab.style.display = 'block';
          } else {
            fab.style.display = 'none';
          }
        },

        _handleCommentInput: function(e) {
          this.$$('#sendComment' + e.model.req.id).hidden = false;
        },

        errorHandler: function (e, detail) {
          this.$.toast.text = detail.error.message;
          this.$.toast.open();
        },

        handleResponseGithubIssue: function() {
          this.$.toast.text = 'Issue posted to Github';
          this.$.toast.open();
        },

        closeBottomToolbar: function() {
          this.$.bottomToolbar.hidden = true;
          //TODO: fix unselection as soon as we use iron-list
          for (var i=0; i < this.selectedRequirements.length; i++) {
            this.$$('#checkbox' + this.selectedRequirements[i]).checked = false;
            //this.$$('#checkbox' + this.selectedRequirements[i]).hidden = true;
          }
          this.selectedRequirements = [];
        },

        handleResponseEditReq: function(data) {
          if (data != null) {
            this.feedback = this.localize('reqEditSucc');
            this.refresh();
          }
          this.$.toast.open();
        },

        openCommentsDialog: function(e) {
          this.$.commentsDialog.querySelector("comments-list").requirementId = e.currentTarget.atr;
          this.$.commentsDialog.querySelector("comments-list").refresh();
          this.$.commentsDialog.open();
        },

        deleteLeftoverComment: function(e) {
          this.$.commentsDialog.querySelector("comments-list").comments = [];
        },

        searchFilter: function (val) {
          return function (item) {
            if (!val) {
              return true;
            }
            //return (item.name && ~item.name.toLowerCase().indexOf(val.toLowerCase()));
            return (item.title && ~item.title.toLowerCase().indexOf(val.toLowerCase())) || (item.description && ~item.description.toLowerCase().indexOf(val.toLowerCase()));
          };
        },

        /**
         * Handles tapping a requirement.
         *
         * @param e
         */
        _handleRequirementTap: function(e) {
          var requirementNode = this.$$('#requirement' + e.model.req.id);
          var descriptionNode = requirementNode.querySelector('#description' + e.model.req.id);

          if (requirementNode.querySelector('iron-collapse').opened) {
            // remove elevation
            requirementNode.elevation = 1;
            // close the requirement
            requirementNode.querySelector('iron-collapse').hide();
            // make description gray
            descriptionNode.classList.toggle('inactive');
            // reset route
            this.set('route.path', '');
          } else {
            // set elevation
            requirementNode.elevation = 4;
            // open the requirement
            requirementNode.querySelector('iron-collapse').show();
            // make description gray
            descriptionNode.classList.toggle('inactive');
            // load comments
            requirementNode.querySelector('comments-list').refresh();
            // load attachments
            requirementNode.querySelector("file-gallery").loadIcons();
            this.set('route.path', '/requirements/' + e.model.req.id);
          }
        },

        _handleCommentEnter: function (e) {
          if (e.keyCode === 13) {
            if (!e.ctrlKey) {
              if (this.viewOption === 'list') {
                this._handleAddCommentTap(e);
              } else {
                this.postGridComment(e);
              }
              e.preventDefault();
            } else {
              e.currentTarget.value += "<br/>";
            }
          }
        },

        searchGithubRepo: function (e) {
          if (e.keyCode === 13) {
            if (!e.ctrlKey) {
              var req = this.$.getSearchGit;
              req.url = "https://api.github.com/search/repositories?q=" + encodeURIComponent(this.$.searchGithubRepo.value);
              req.generateRequest();
              e.preventDefault();
            }
          }
        },

        validateUrl: function(requirementDesc) {
          var str = requirementDesc;
          var expression = /\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost(?=\/)|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi;
          var regex = new RegExp(expression);

          if(!str.match(regex)) {
            return str;
          } else {
            var txt = str;
            for (var i = 0; i < str.match(regex).length; i++) {
              var replacement;
              if (str.match(regex)[i].startsWith("http")) {
                replacement = "<a href='" + str.match(regex)[i] + "' target='_blank' class='highlight'>"+ str.match(regex)[i] +"</a>"
              } else {
                replacement = "<a href='http://" + str.match(regex)[i] + "' target='_blank' class='highlight'>"+ str.match(regex)[i] +"</a>"
              }
              txt = txt.replace(str.match(regex)[i], replacement);
            }
            return txt;
          }
        },

        dragRequirement: function() {
        },

        /**
         * Calculates the specific star icon to show for the voting feature of the requirements.
         *
         * @param vote the vote field coming from the backend, either 'UP_VOTE' or 'NO_VOTE'.
         * @param authorized whether the user is currently logged in or not.
         * @returns {string} the icon, either a filled star or just the outlines of a star.
         * @private
         */
        _calculateStarIcon: function(vote, authorized) {
          if (authorized && (vote === 'UP_VOTE')) {
            return 'star';
          }
          return 'star-border';
        },

        /**
         * Calculates the CSS class for the star icon of the voting feature of the requirements.
         *
         * @param vote the vote field coming from the backend, either 'UP_VOTE' or 'NO_VOTE'.
         * @param authorized whether the user is currently logged in or not.
         * @returns {string} the CSS class for the star icon.
         * @private
         */
        _calculateStarClass: function(vote, authorized) {
          if (authorized && (vote === 'UP_VOTE')) {
            return 'colored';
          }
        },

        /**
         * Handles tapping the star icon.
         *
         * @param e
         * @private
         */
        _handleStarTap: function(e) {
          // first, get the dom-repeat's template instance that generated the item
          var model = e.model;
          var vote = model.req.userVoted;
          var requirementId = model.req.id;

          var request = this.$.starRequest;
          request.url = this._apiBaseUrl + "/requirements/" + requirementId + "/vote";

          // now construct the method and body based on the action
          if (vote === 'NO_VOTE') {
            request.method = 'POST';
            request.body = JSON.stringify({
              "requirementId": requirementId,
              "direction": "up"
            });

            // give user immediate feedback
            Polymer.dom(e).localTarget.toggleClass('colored');
            e.target.setAttribute('icon', 'star');
          } else {
            request.method = 'DELETE';

            // give user immediate feedback
            Polymer.dom(e).localTarget.toggleClass('colored');
            e.target.setAttribute('icon', 'star-border');
          }

          // fire the event to the server
          request.generateRequest();
        },

        /**
         * Checks whether a user is in the users array. Compares the user's id.
         *
         * @param usersArray an array of user objects.
         * @param user a user object.
         * @returns {boolean} whether the user is in the array or not.
         * @private
         */
        _isUserInArray: function(usersArray, user) {
          if (user === null) {
            return false;
          } else {
            // check if the user's id is in the users array
            for (var index = 0; index < usersArray.length; ++index) {
              if (usersArray[index].id === user.id) {
                return true;
              }
            }

            return false;
          }
        },

        /**
         * Calculates the localized message based on whether the provided user is in the provided array of user objects.
         *
         * @param userArray an array of user objects.
         * @param user the currently logged in user's object. This is to be notified by the data
         *   binding system of Polymer about changes, and recalculate the value.
         * @param falseMessage the text to show when the user is not in the array.
         * @param trueMessage the text to show when the user is in the array.
         * @returns {string} the localized message.
         * @private
         */
        _calculateMessageBasedOnUserInArray: function(userArray, falseMessage, trueMessage) {
          if (this.authorized && this.currentUser && this._isUserInArray(userArray, this.currentUser)) {
            return this.localize(trueMessage);
          } else {
            return this.localize(falseMessage);
          }
        },

        _calculateLeadDeveloperLocalization: function(leadDeveloperId) {
          if (this.currentUser && (this.currentUser.id === leadDeveloperId)) {
            return this.localize('stopLeadDeveloper');
          }

          return this.localize('becomeLeadDeveloper');
        },

        /**
         * Handles toggling the following of requirements by firing the state to the server.
         *
         * @param requirement the requirement to (un)follow.
         * @returns {boolean}
         * @private
         */
        _toggleFollowRequirement: function(requirement) {
          var requirementId = requirement.id;

          var followers = requirement.followers;
          var isFollower = this._isUserInArray(followers, this.currentUser);

          var request = this.$.followRequest;
          request.url = this._apiBaseUrl + "/requirements/" + requirementId + "/followers";

          if (!isFollower) {
            // follow requirement
            request.method = 'POST';
          } else {
            // unfollow requirement
            request.method = 'DELETE';
          }

          request.generateRequest();
        },

        /**
         * Handles the iron-ajax response for following/unfollowing requirements,
         * shows toast message.
         *
         * @param data
         * @private
         */
        _handleFollowResponse: function(e) {
          var status = e.detail.status;

          if (status === 200) {
            this.feedback = this.localize('fdbUnfollowReq');
          } else if (status === 201) {
            this.feedback = this.localize('fdbFollowReq');
          } else {
            //TODO: add i18n
            this.feedback = 'error';
          }

          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Handles toggling the existence of a user within an HTTP resource.
         * TODO: currently only for resource 'developers'
         *
         * @param e
         * @returns {boolean}
         * @private
         */
        _toggleUserInResource: function(requirementId, userArray, resource) {
          var isUserInArray = this._isUserInArray(userArray, this.currentUser);

          var request = this.$.userInResourceRequest;
          request.url = this._apiBaseUrl + "/requirements/" + requirementId + "/" + resource;

          if (!isUserInArray) {
            // POST user to resource
            request.method = 'POST';
          } else {
            // DELETE user from resource
            request.method = 'DELETE';
          }

          request.generateRequest();
        },

        /**
         * Handles the iron-ajax response for posting/deleting users to/from a resoure,
         * shows toast message.
         *
         * @param data
         * @private
         */
        _handleUserInResourceResponse: function(e) {
          var method = e.target.method;

          if (method === 'DELETE') {
            this.feedback = this.localize('fdbUndevelopReq');
          } else if (method === 'POST') {
            this.feedback = this.localize('fdbDevelopReq');
          } else {
            //TODO: add i18n
            this.feedback = 'error';
          }

          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Event handler for requirement's paper-menu.
         *
         * @param e
         * @private
         */
        _handleRequirementMenuSelect: function(e) {
          // unselect the selected menu item
          e.target.selected = null;
          // get value of the paper-item
          var selectedValue = e.detail.item.getAttribute('value');
          var requirement = e.model.req;

          if (selectedValue === 'follow') {
            this._toggleFollowRequirement(requirement);
          } else if (selectedValue === 'toggleContributors') {
            this._toggleContributors(requirement);
          } else if (selectedValue === 'develop') {
            this._toggleUserInResource(requirement.id, requirement.developers, 'developers');
          } else if (selectedValue === 'realize') {
            this._toggleRealized(requirement);
          } else if (selectedValue === 'delete') {
            this.requirementToDelete = requirement;
            this.$.modal.open();
          } else if (selectedValue === 'becomeLeadDeveloper') {
            this._toggleLeadDeveloper(requirement);
          } else if (selectedValue === 'edit') {
            this._editRequirement(requirement.id);
          }
        },

        /**
         * Toggles the 'realized' property of a requirement on the server. If the requirement was not realized yet,
         * the current timestamp is sent to the server. Otherwise, the realized property is reset.
         *
         * @param requirement {object} the requirements object.
         */
        _toggleRealized: function(requirement) {
          var request = this.$.updateRequirementRequest;
          request.url = this._apiBaseUrl + "/requirements/" + requirement.id;

          if (requirement.hasOwnProperty('realized')) {
            // unrealize it
            request.body = JSON.stringify({
              "id": parseInt(requirement.id),
              "realized": null
            });
          } else {
            // realize it
            var today = new Date();
            var month = today.toDateString().substring(4, 7);
            var date = today.getDate();
            var year = today.getUTCFullYear();
            var hours = today.getHours();
            var minutes = today.getMinutes();
            var seconds = today.getSeconds();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0'+minutes : minutes;
            seconds = seconds < 10 ? '0'+seconds : seconds;
            var strTime = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
            var dateString = month + ' ' + date + ', ' + year + ' ' + strTime;

            request.body = JSON.stringify({
              "id": parseInt(requirement.id),
              "realized": dateString
            });
          }

          // fire
          request.generateRequest();
        },

        /**
         * Handles the iron-ajax response for updating requirements, shows toast message.
         *
         * @param e
         * @private
         */
        _handleUpdateRequirementResponse: function(e) {
          if (e != null) {
            this.feedback = this.localize('reqEditSucc');
          }

          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Toggles the state of contributors' bar.
         *
         * @param requirement a requirement object.
         * @private
         */
        _toggleContributors: function(requirement) {
          var contributorNode = this.$$('#contributors' + requirement.id);
          this.toggleAttribute('hidden', contributorNode.getAttribute('hidden') == null, contributorNode);
        },

        /**
         * Calculates the localized message for the realized menu button, depending on whether the requirement is realized or
         * not.
         *
         * @param realized
         * @returns {*}
         * @private
         */
        _calculateRealizeMessage: function(realized) {
          if (realized) {
            return this.localize('markAsUnDone');
          } else {
            return this.localize('markAsDone');
          }
        },

        /**
         * Handles the delete modal dialog closed event.
         *
         * @param e
         * @private
         */
        _handleDeleteRequirement: function(e) {
          if (e.detail.confirmed) {
            var requirement = this.requirementToDelete;
            var request = this.$.deleteRequirementRequest;
            request.url = this._apiBaseUrl + '/requirements/' + requirement.id;

            request.generateRequest();
          }
        },

        /**
         * Handles the result of the DELETE requirement request.
         *
         * @param e
         * @private
         */
        _handleDeleteRequirementResponse: function(e) {
          //TODO: check result

          this.feedback = this.localize('reqDelSucc');
          this.$.toast.open();

          // now refresh the data behind by reloading all requirements
          // TODO: eliminate this heavy operation by only refreshing the respective requirement
          this.refresh();
        },

        /**
         * Updates the lead developer for a specified requirement on the server. If the user is already lead developer,
         * then the user 1 (anonymous) is becoming lead developer, otherwise the user takes this role.
         *
         * @param requirement a requirement object.
         * @private
         */
        _toggleLeadDeveloper: function(requirement) {
          var request = this.$.updateRequirementRequest;
          request.url = this._apiBaseUrl + '/requirements/' + requirement.id;
          request.body = JSON.stringify({
            'id': requirement.id,
            'leadDeveloperId': (this.currentUser.id !== requirement.leadDeveloperId) ? this.currentUser.id : 1
          });

          // fire
          request.generateRequest();
        },

        /**
         * Shows the editing form of the specified requirement.
         *
         * @param requirementId
         * @private
         */
        _editRequirement: function(requirementId) {
          //hide card elements
          this.$$('#requirementBody' + requirementId).style.display = 'none';
          this.$$('#comments' + requirementId).style.display = 'none';
          this.$$('#description' + requirementId).style.display = 'none';
          //show form elements
          this.$$('#edit' + requirementId).style.display = 'block';
        },

        /**
         * Saves the edited requirement on the server.
         *
         * @param e
         * @private
         */
        _handleSaveEditTap: function(e) {
          // refactoring: formerly known as saveEditReq

          var model = e.model;

          //TODO: use proper ids!
          var title = e.currentTarget.parentNode.querySelector('PAPER-INPUT').value;
          var description = e.currentTarget.parentNode.querySelector('PAPER-TEXTAREA').value;

          var request = this.$.postUpdateRequirement;
          //TODO: check if this is not harmful code when requirement belongs to multiple categories
          var categories = [{id: this.categoryId}];
          request.url = this._apiBaseUrl + "/requirements/" + model.req.id;

          if (title != '' && description != '') {
            request.body = JSON.stringify({
              "id": model.req.id,
              "title": title,
              "description": description,
              "projectId": this.projectId,
              "components": categories
            });
            request.generateRequest();

            // revert the look
            this._handleCancelEditTap(e);

          } else {
            this.$.toast.text = this.localize('fieldsNotEmptyReq');
            this.$.toast.open();
          }
        },

        /**
         * Cancels editing a requirement by hiding the form.
         *
         * @param e
         * @private
         */
        _handleCancelEditTap: function(e) {
          // refactoring: formerly known as cancelRequirement
          var requirementId = e.model.req.id;

          // show form elements
          this.$$('#edit' + requirementId).style.display = 'none';

          // show card elements
          this.$$('#requirementBody' + requirementId).style.display = 'block';
          this.$$('#comments' + requirementId).style.display = 'block';
          this.$$('#description' + requirementId).style.display = 'block';
        },

        /**
         * Reset the view when the category id changes.
         *
         * @param categoryId
         * @private
         */
        _categoryIdChanged: function(categoryId) {
          this.resetView();
        },

        resetView: function() {
          //TODO: this seems to be a rather naive approach...
          this.requirements = [];
        }

      });

    })();
  </script>

</dom-module>
