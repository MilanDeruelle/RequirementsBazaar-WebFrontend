<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/openidconnect-signin/openidconnect-signin-aware.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="req-user.html">
<link rel="import" href="comments-list.html">
<link rel="import" href="file-gallery.html">
<link rel="import" href="requirement-card.html">
<link rel="import" href="../src/shared-styles.html">
<link rel="import" href="../src/config-behavior.html">

<script src="../bower_components/masonry/dist/masonry.pkgd.js"></script>

<dom-module id="requirements-list">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
        height: 100%;
        width: 100%;
      }

      paper-card {
        max-width: 300px;
        min-width: 300px;
      }

      #requirementsList {
        @apply(--layout-center);
        height: 100%;
        width: 100%;
      }

      paper-material {
        display: block;
        border-radius: 2px;
        width: 100%;
        max-width: 800px;
        box-sizing: border-box;
        margin: 5px;
        padding: 0 16px 0 16px;
        background: white;
      }

      paper-fab {
        --paper-fab-background: var(--default-primary-color);
      }

      paper-toast {
        z-index: 105;
      }

      .flex-horizontal {
        @apply(--layout-horizontal);
      }

      .flexchild {
        @apply(--layout-flex);
      }

      .flex-end-align {
        margin-top: auto;
        margin-bottom: auto;
      }

      paper-button {
        float: right;
        margin: 20px;
      }

      .hide {
        display: none;
      }

      #bottomToolbar {
        position: fixed;
        bottom: 50px;
        left: 10px;
        z-index: 105;
        width: auto;
        padding: 10px;
      }

      #grid .starIcon {
        float: right;
        margin: 20px;
      }

      .grid-item {
        margin: 5px;
        margin-bottom: 10px;
        width: 250px;
      }

      iron-scroll-threshold {
        height: 100%;
        overflow: auto;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/requirements/:requirementId"
      data="{{data}}"></app-route>

    <openidconnect-signin-aware is-authorized="{{authorized}}"
                                on-openidconnect-signin-aware-success="_handleSigninSuccess"
                                on-openidconnect-signin-aware-signed-out="_handleSignedOut"></openidconnect-signin-aware>

    <iron-signals on-iron-signal-language-changed="_handleLanguageChanged"></iron-signals>
    <iron-signals on-iron-signal-resize="_handleIronResize"></iron-signals>
    <iron-signals on-iron-signal-menu-open="_handleMenuOpen"></iron-signals>
    <iron-signals on-iron-signal-menu-close="_handleMenuClose"></iron-signals>
    <iron-signals on-iron-signal-show-toast="_handleShowToast"></iron-signals>
    <iron-signals on-iron-signal-delete-requirement="_handleDeleteRequirement"></iron-signals>
    <iron-signals on-iron-signal-delete-comment="_handleDeleteComment"></iron-signals>
    <iron-signals on-iron-signal-select-requirement="_handleSelectRequirement"></iron-signals>
    <iron-signals on-iron-signal-unselect-requirement="_handleUnselectRequirement"></iron-signals>

    <iron-ajax id="requirementsRequest"
               loading="{{loading}}"
               url="[[_resourceUrl]]"
               headers="[[authHeader]]"
               params="[[_requirementsRequestParameters]]"
               on-response="_handleRequirementsResponse"
               debounce-duration="600"
               auto></iron-ajax>

    <iron-ajax id="deleteRequirementRequest"
               loading="{{loading}}"
               handle-as="json" content-type="application/json"
               method="DELETE"
               headers="[[authHeader]]"
               on-response="_handleDeleteRequirementResponse"
               on-error="errorHandler"></iron-ajax>

    <iron-ajax id="postCommentRequest"
               loading="{{loading}}"
               handle-as="json"
               url="{{_apiBaseUrl}}/comments"
               content-type="application/json"
               method="POST"
               headers="[[authHeader]]"
               on-response="_handleCommentResponse"
               last-response="{{postResponse}}"
               on-error="errorHandler"></iron-ajax>

    <iron-ajax id="deleteCommentRequest"
               loading="{{loading}}"
               handle-as="json"
               content-type="application/json"
               method="DELETE"
               headers="[[authHeader]]"
               on-response="_handleDeleteCommentResponse"
               on-error="errorHandler"></iron-ajax>

        <!--<iron-ajax-->
                <!--id="postIssueGit"-->
                <!--handle-as="json"-->
                <!--content-type="application/json"-->
                <!--params='{"access_token": ""}'-->
                <!--method="POST"-->
                <!--on-response="handleResponseGithubIssue"-->
                <!--on-error="errorHandler"></iron-ajax>-->

        <!--<iron-ajax-->
                <!--id="getSearchGit"-->
                <!--handle-as="json"-->
                <!--content-type="application/json"-->
                <!--method="GET"-->
                <!--last-response="{{searchRepositories}}"-->
                <!--on-response="showRepoSearchResults"-->
                <!--on-error="errorHandler"></iron-ajax>-->

    <!--
      <iron-list id="requirementsList"
                 items="[[filterItems(requirements, searchFilter, requirements.*)]]"
                 scroll-target="document"
                 scroll-offset="405">
        <template>
          <requirement-card loading="{{loading}}" route="{{route}}" requirement="[[item.requirementItem]]"></requirement-card>
        </template>
      </iron-list>
      -->

    <div id="list" hidden="[[!_isViewActive(viewOption, 'list')]]">
      <template is="dom-repeat" items="{{requirements}}" filter="{{filterItems(searchFilter)}}" initial-count="5">
        <requirement-card id$="requirement{{item.requirementItem.id}}" loading="{{loading}}" route="{{route}}" requirement="[[item.requirementItem]]"></requirement-card>
      </template>
    </div>

    <div id="grid" hidden="[[!_isViewActive(viewOption, 'grid')]]">
      <template is="dom-repeat" items="{{requirements}}" filter="{{filterItems(searchFilter)}}" initial-count="5" on-dom-change="_handleGridDomChange">
        <paper-card heading="{{item.requirementItem.title}}" elevation="2" class="grid-item">
          <div style="display:inline-flex; padding-left: 16px;"><span>[[localize('by')]] <req-user user="[[item.requirementItem.creator]]" normal-view></req-user></span></div>
          <relative-time class="time" datetime$="[[item.requirementItem.creation_time]]"></relative-time>
          <div class="card-content" class="truncate">{{item.requirementItem.description}}</div>
          <div class="card-actions">
            <paper-button on-tap="openCommentsDialog">
              <iron-icon icon="editor:mode-comment"></iron-icon>
              [[item.requirementItem.numberOfComments]]
            </paper-button>
            <span class="starIcon">
              <paper-icon-button icon="[[_calculateStarIcon(item.requirementItem.userVoted, authorized)]]"
                                 class$="[[_calculateStarClass(item.requirementItem.userVoted, authorized)]]"
                                 on-tap="_handleStarTap"
                                 disabled="[[!authorized]]"></paper-icon-button>
              [[item.requirementItem.upVotes]]
            </span>
          </div>
        </paper-card>
      </template>
    </div>

    <!-- this element will load more data when the user scrolls down and reached the lower threshold -->
    <iron-scroll-threshold id="scrollThreshold"
                           on-lower-threshold="_loadMoreData"
                           scroll-target="document">
    </iron-scroll-threshold>

    <!-- Dialog for GitHub export functionality: -->

    <paper-dialog id="reposContainer" on-iron-overlay-closed="onRepoDialogClosed">
      <h2>Your Github Repositories</h2>
      <paper-dialog-scrollable>
        <paper-input id="searchGithubRepo" label="Search a Github Repository" on-keydown="searchGithubRepo">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
        <iron-selector id="selRepo" selected="0">
          <template is="dom-repeat" items$="{{repositories}}" id="repoElements">
            <paper-item>
              <paper-item-body two-line>
                <div>{{item.name}}</div>
                <div secondary>{{item.description}}</div>
              </paper-item-body>
            </paper-item>
          </template>
        </iron-selector>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus>POST</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for confirming the deletion of a requirement: -->

    <paper-dialog id="deleteRequirementDialog"
                  on-iron-overlay-closed="_handleDeleteRequirementClosed"
                  entry-animation="fade-in-animation"
                  exit-animation="fade-out-animation"
                  modal>
      <h2>[[localize('deleteRequirement')]]?</h2>
      <p>[[localize('deleteRequirementDesc')]]</p>
      <div class="buttons">
        <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
        <paper-button dialog-confirm autofocus>[[localize('delete')]]</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for deleting a comment -->

    <paper-dialog id="deleteCommentDialog"
                  entry-animation="fade-in-animation"
                  exit-animation="fade-out-animation"
                  on-iron-overlay-closed="_handleDeleteCommentDialogClosed"
                  modal>
      <h2>[[localize('delCommTitle')]]?</h2>
      <p>[[localize('delCommDesc')]]</p>
      <div class="buttons">
        <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
        <paper-button dialog-confirm autofocus>[[localize('delete')]]</paper-button>
      </div>
    </paper-dialog>

    <!-- Dialog for showing comments in the grid view: -->

    <paper-dialog id="commentsDialog" on-iron-overlay-closed="deleteLeftoverComment" entry-animation="fade-in-animation" exit-animation="fade-out-animation"
                  style="min-width:40%; max-width:85%; top:100px; max-height: 80%; overflow:scroll;">
      <h2>[[localize('comments')]]</h2>
      <p style="max-height: 80%;">
        <comments-list base-href="{{_apiBaseUrl}}"></comments-list>
      <div class="container flex-horizontal" hidden="[[!authorized]]">
        <paper-input is="iron-input" on-input="_handleCommentInput" label="[[localize('addComment')]]" class="flexchild comments-input" on-keydown="_handleCommentEnter">
        </paper-input>
        <paper-fab id="fab" mini icon="send" class="flex-end-align" on-tap="postGridComment"></paper-fab>
      </div>
      </p>
    </paper-dialog>

    <!-- Floating toolbar for selected requirements: -->

    <paper-material elevation="5" id="bottomToolbar" hidden>
      <span>{{selectedRequirements.length}} Requirements selected.</span>
      <paper-icon-button icon="file-download" on-tap="_exportSelectedRequirements"></paper-icon-button>
      <paper-icon-button icon="close" on-tap="_closeBottomToolbar"></paper-icon-button>
    </paper-material>

    <!-- Toast for toast notifications: -->

    <paper-toast id="toast" text="[[toastFeedback]]"></paper-toast>

  </template>

  <script>
    (function () {
      //'use strict';

      Polymer({
        is: 'requirements-list',
        listeners: {
          //'change': 'addToSelectedReq'
        },

        behaviors: [
          ConfigBehavior
        ],

        properties: {
          route: {
            type: Object,
            notify: true
          },
          categoryId: {
            type: Number
          },
          /**
           * The sorting parameter of requirements, either `date`, `title`, `vote`, `comment`, `follower` or `realized`.
           */
          sorting: {
            type: String,
            value: 'date',
            notify: true
          },
          sortDirection: {
            type: String,
            value: '-',
            notify: true,
            reflectToAttribute: true
          },
          /**
           * Whether to show 'open' or 'realized' requirements.
           */
          requirementsStateFilter: {
            type: String,
            value: 'open',
            notify: true
          },
          viewOption: {
            type: String,
            value: 'list',
            notify: true,
            observer: '_viewOptionChanged'
          },
          _resourceUrl: {
            type: String,
            computed: '_computeResourceURL(_apiBaseUrl, categoryId)'
          },
          _lastRequestCategoryId: {
            type: Number
          },
          _lastRequestSorting: {
            type: String
          },
          requirements: {
            type: Array
          },
          selectedRequirements: {
            type: Array,
            value: [],
            notify: true
          },
          postUrl: String,
          body: Object,
          postResponse: Object,
          /**
           * The text shown on the paper-toast element for notifying the user.
           */
          toastFeedback: String,
          header: {
            type:Object,
            notify: true
          },
          /**
           * Search filter for the requirements list.
           */
          searchFilter: {
            type: String,
            value: '',
            //observer: '_searchFilterChanged'
          },
          /**
           * The parameters for the request to the requirements resource.
           */
          _requirementsRequestParameters: {
            type: Object,
            notify: true,
            computed: '_computeRequirementsRequestParameters(_apiBaseUrl, categoryId, sorting, sortDirection, requirementsStateFilter, _requirementsRequestPerPage, _requirementsRequestCurrentPage, searchFilter)',
            observer: '_requirementsRequestParametersUpdated'
          },
          /**
           * Defines how many requirements are loaded per page.
           * TODO: recalculate when resizing the window.
           */
          _requirementsRequestPerPage: {
            type: Number,
            value: 14
          },
          /**
           * Stores the current page number.
           */
          _requirementsRequestCurrentPage: {
            type: Number,
            value: 0 // because we get a scroll lower threshold event once the page loads
          },
          /**
           * The requirement's element to be deleted.
           */
          elem: Object,
          /**
           * Stores the requirement that is going to be deleted, while modal dialog is shown.
           */
          requirementToDelete: {
            type: Object
          },
          commentToDeleteData: {
            type: Object
          },
          filterValue: {
            type: String,
            value: ''
          },
          /**
           * Whether any loading operation is currently active.
           */
          loading: {
            type: Boolean,
            notify: true
          },
          buttons: {
            type: Array,
            value: [],
            notify: true
          },
          list: {
            type: Boolean,
            notify: true,
            observer: "_hasEnoughItems"
          },
          repositories: {
            type: Object,
            notify: true,
            reflectToAttribute: true
          },
          _contributorsVisible: {
            type: Object,
            value: []
          }
        },

        observers: [
          'manageSelReq(selectedRequirements.splices)',
          //'_requirementsRequestParametersUpdated(_requirementsRequestParameters)',
          '_routeChanged(route)',
          '_categoryIdChanged(categoryId)'
        ],

        _routeChanged: function(route) {
          if ((route.path === '') || (route.path === '/')) {
            //TODO: reset open requirements
          }
        },

        _hasEnoughItems: function () {
          if (!this.viewOption !== 'list') {
            var n = Math.floor((window.innerWidth - 300) / 300);
            var free = (window.innerWidth - 300) - n * (300 + 20);
            this.style.paddingLeft = "" + free / 2 + "px";
          } else {
            this.style.paddingLeft = "0px";
          }
        },

        /**
         * Called when the requirement DOM has been stamped. Triggers the masonry layout.
         *
         * @param e
         */
        _handleGridDomChange: function(e) {
          var columnWidth = 250;

          var grid = this.$.grid;
          var msnry = new Masonry(grid, {
            itemSelector: 'requirement-card',
            gutter: 10,
            columnWidth: columnWidth
          });
        },

        _viewOptionChanged: function(viewOption) {
          var columnWidth = 250;

          var grid = this.$.grid;
          var msnry = new Masonry(grid, {
            itemSelector: 'requirement-card',
            gutter: 20,
            //fitWidth: true,
            columnWidth: columnWidth
          });

          this.$.scrollThreshold.scroll(0, 0);

          // load more items if we changed to grid
          if (viewOption === 'grid') {
            this._loadMoreData();
          }
        },

        _isViewActive: function(viewOption, view) {
          return (viewOption === view);
        },

        /**
         * Computes the resource URL for the requirements request.
         */
        _computeResourceURL: function (apiBaseUrl, categoryId) {
          return apiBaseUrl + '/categories/' + categoryId + '/requirements';
        },

        _searchFilterChanged: function(searchFilter) {
          this.$.scrollThreshold.clearTriggers();
          this._requirementsRequestCurrentPage = 0;
        },

        /**
         * Computes the parameter array for the request to the requirements resource.
         *
         * @param requirementsStateFilter {string} the requirement's state, either 'open', 'realized' or 'all'.
         */
        _computeRequirementsRequestParameters: function(apiBaseUrl, categoryId, sorting, sortDirection, requirementsStateFilter, requirementsRequestPerPage, requirementsRequestCurrentPage, searchFilter) {
          this._resourceUrl = apiBaseUrl + '/categories/' + categoryId + '/requirements';

          if (this._requirementsRequestParameters) {

            // if we have a new search string, a new component ID or a new state, reset the page to 0
            if ((this._requirementsRequestParameters.search !== searchFilter) ||
                (this._requirementsRequestParameters.state !== requirementsStateFilter) ||
                (this._lastRequestCategoryId !== categoryId)) {
              this._requirementsRequestCurrentPage = 0;
              requirementsRequestCurrentPage = 0;

              // scroll to top
              this.$.scrollThreshold.scroll(0, 0);
            }

            // if we have a new sorting parameter, reset the sort direction
            if (this._lastRequestSorting !== sorting) {
              if (['date', 'vote', 'comment', 'follower'].indexOf(sorting) >= 0) {
                this.sortDirection = '-';
                sortDirection = '-';
              } else {
                this.sortDirection = '+';
                sortDirection = '+';
              }
            }

            // check if we have a new sorting or state parameter; if yes, reset the list
            if ((this._requirementsRequestParameters.sort !== (sortDirection + sorting)) || (this._requirementsRequestParameters.state !== requirementsStateFilter)) {
              this.requirements = [];
              this._requirementsRequestCurrentPage = 0;
              requirementsRequestCurrentPage = 0;

              // scroll to top
              this.$.scrollThreshold.scroll(0, 0);
            }
          }

          this._lastRequestCategoryId = categoryId;
          this._lastRequestSorting = sorting;

          var parameters = new Object();
          parameters.sort = sortDirection + sorting;
          parameters.per_page = requirementsRequestPerPage;
          parameters.page = requirementsRequestCurrentPage;
          // better check this type as it's a public property of the element
          if (requirementsStateFilter === 'open') {
            parameters.state = 'open';
          } else if (requirementsStateFilter === 'realized') {
            parameters.state = 'realized';
          } else if (requirementsStateFilter === 'all') {
            parameters.state = 'all';
          }
          parameters.search = searchFilter;

          return parameters;
        },

        /**
         * Called when some of the requirements request parameters change, e.g. the state is set from 'open' to
         * 'realized'. In that case, we need to refresh the requirements list.
         *
         * @param _requirementsRequestParameters {array} the requirements request parameter.
         */
        _requirementsRequestParametersUpdated: function(_requirementsRequestParameters) {
          //this.refresh();
        },

        refresh: function() {
          this.$.requirementsRequest.generateRequest();
        },

        manageSelReq: function(selReq) {
          if (this.selectedRequirements.length !== 0) {
            this.$.bottomToolbar.hidden = false;
          }
        },

        showRepoSearchResults: function() {
          this.repositories = this.searchRepositories.items;
        },

        _exportSelectedRequirements: function(e) {
          var selectedRequirements = [];
          for (var i=0; i < this.selectedRequirements.length; i++) {
            for (var j=0; j < this.requirements.length; j++) {
              if (parseInt(this.selectedRequirements[i]) === this.requirements[j].requirementItem.id) {
                selectedRequirements.push(this.requirements[j].requirementItem);
              }
            }
          }

          //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
          var arrData = typeof selectedRequirements != 'object' ? JSON.parse(selectedRequirements) : selectedRequirements;

          var CSV = '';
          //Set Report title in first row or line

          CSV += 'Requirements of ' + arrData[0].categories[0].name + '\r\n\n';

          var row = 'TITLE, DESCRIPTION, CREATION DATE, CREATOR, DEVELOPERS, FOLLOWERS, CATEGORY';

          //append Label row with line break
          CSV += row + '\r\n';

          //1st loop is to extract each row
          for (var i = 0; i < arrData.length; i++) {
            var row = '';

            row += '"' + arrData[i].title + '",';
            row += '"' + arrData[i].description + '",';
            row += '"' + arrData[i].creation_time + '",';
            row += '"' + arrData[i].creator.userName + '",';
            row += '"' + arrData[i].developers.length + '",';
            row += '"' + arrData[i].followers.length + '",';
            row += '"' + arrData[i].categories[0].name + '"';

            //add a line break after each row
            CSV += row + '\r\n';
          }

          if (CSV == '') {
            //TODO: display toast
            alert('Invalid data');
            return;
          }

          //Generate a file name
          var fileName = arrData[0].categories[0].name + '_';
          //this will remove the blank-spaces from the title and replace it with an underscore
          fileName += 'Requirements'.replace(/ /g, '_');

          //Initialize file format you want csv or xls
          var uri = 'data:text/csv;charset=utf-8,' + encodeURI(CSV);

          //this trick will generate a temp <a /> tag
          var link = document.createElement('a');
          link.href = uri;

          //set the visibility hidden so it will not effect on your web-layout
          link.style = 'visibility:hidden';
          link.download = fileName + '.csv';

          //this part will append the anchor tag and remove it after automatic click
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        },

        postGridComment: function(e) {
          var reqId = e.currentTarget.parentNode.parentNode.querySelector('comments-list').requirementId;
          var request = this.$.postCommentRequest;
          var message = e.currentTarget.value;
          request.body = JSON.stringify({
            "requirementId": reqId,
            "message": message
          });
          request.generateRequest();

          e.currentTarget.value = '';
          e.currentTarget.parentNode.parentNode.querySelector('.comments-input').value = null;
        },

        showGithubRepos: function(e) {
          this.$.reposContainer.open();
          var el = e.currentTarget;
          var tag = 'PAPER-MATERIAL';
          var element;

          while (el.parentNode) {
            el = el.parentNode;
            if (el.tagName === tag)
              element = el;
          }
          this.selReq = element.id;
        },

        onRepoDialogClosed: function (e) {
          if(e.detail.confirmed) {
            var title = "";
            var desc = "";
            for (var i=0; i < this.requirements.length; i++) {
              if (this.requirements[i].id == this.selReq) {
                title = this.requirements[i].title;
                desc = this.requirements[i].description;
              }
              break;
            }
            var req = this.$.postIssueGit;
            req.url = 'https://api.github.com/repos/' + this.repositories[parseInt(this.$.selRepo.selected)].full_name + '/issues';
            req.body = JSON.stringify({
              "title": title,
              "body": desc
            });
            req.generateRequest();
          } else {
            this.$.selRepo.selected = '0';
            this.selReq = null;
          }
        },

        _handleAddCommentTap: function(e) {
          var currentReqId = e.model.req.id;
          var request = this.$.postCommentRequest;
          var message;
          if (this.viewOption === 'list') {
            message = this.$$('#comment' + currentReqId).value;
          } else {
            message = this.$.commentsDialog.querySelector('paper-input').value;
          }
          if (message != null && (message !== '')) {
            request.body = JSON.stringify({
              "requirementId": parseInt(currentReqId),
              "message": message
            });
            request.generateRequest();
          } else {
            this.$.toast.text = this.localize('commentNoEmpty');
            this.$.toast.open();
          }
          var message;
          if (this.viewOption === 'list') {
            this.$$('#comment' + currentReqId).value = '';
          } else {
            this.$.commentsDialog.querySelector('paper-input').value = '';
          }
          this.$$('#comment' + currentReqId).value = null;
        },

        _handleCommentResponse: function(data) {
          var requirementId = data.detail.response.requirementId;
          if (this.viewOption === 'list') {
            this.$$('#comments' + requirementId).querySelector('comments-list').refresh();
          } else {
            // reload comments in grid view
            this.$.commentsDialog.querySelector('comments-list').refresh();
          }

        },

        _handleCommentInput: function(e) {
          var fab = e.currentTarget.parentNode.querySelector('#fab');
          var message;
          if (this.viewOption === 'list') {
            message = this.$$('#comment' + requirementId).value;
          } else {
            message = this.$.commentsDialog.querySelector('paper-input').value;
          }
          if (message) {
            fab.style.display = 'block';
          } else {
            fab.style.display = 'none';
          }
        },

        errorHandler: function (e, detail) {
          this.$.toast.text = detail.error.message;
          this.$.toast.open();
        },

        handleResponseGithubIssue: function() {
          this.$.toast.text = 'Issue posted to Github';
          this.$.toast.open();
        },

        _closeBottomToolbar: function() {
          this.$.bottomToolbar.hidden = true;
          //TODO: fix unselection as soon as we use iron-list
          for (var i=0; i < this.selectedRequirements.length; i++) {
            this.$$('#requirement' + this.selectedRequirements[i]).selected = false;
          }
          this.selectedRequirements = [];
        },

        openCommentsDialog: function(e) {
          this.$.commentsDialog.querySelector("comments-list").requirementId = e.model.item.requirementItem.id;
          this.$.commentsDialog.querySelector("comments-list").refresh();
          this.$.commentsDialog.open();
        },

        deleteLeftoverComment: function(e) {
          this.$.commentsDialog.querySelector("comments-list").comments = [];
        },

        /**
        searchFilter: function (val) {
          return function (item) {
            if (!val) {
              return true;
            }
            //return (item.name && ~item.name.toLowerCase().indexOf(val.toLowerCase()));
            return (item.title && ~item.title.toLowerCase().indexOf(val.toLowerCase())) || (item.description && ~item.description.toLowerCase().indexOf(val.toLowerCase()));
          };
        },**/

        _handleCommentEnter: function (e) {
          //TODO: refactor the code
          // keyCode 13 is Enter
          if (e.keyCode === 13) {
            // check if the Enter key was pressed...
            if (!e.ctrlKey) {
              if (this.viewOption === 'list') {
                this._handleAddCommentTap(e);
              } else {
                this.postGridComment(e);
              }
              e.preventDefault();
            } else {
              e.currentTarget.value += "<br/>";
            }
          }
        },

        searchGithubRepo: function (e) {
          if (e.keyCode === 13) {
            if (!e.ctrlKey) {
              var req = this.$.getSearchGit;
              req.url = "https://api.github.com/search/repositories?q=" + encodeURIComponent(this.$.searchGithubRepo.value);
              req.generateRequest();
              e.preventDefault();
            }
          }
        },

        dragRequirement: function() {
        },

        /**
         * Handles the delete modal dialog closed event.
         *
         * @param e
         * @private
         */
        _handleDeleteRequirementClosed: function(e) {
          if (e.detail.confirmed) {
            var requirement = this.requirementToDelete;
            var request = this.$.deleteRequirementRequest;
            request.url = this._apiBaseUrl + '/requirements/' + requirement.id;

            request.generateRequest();
          }
        },

        /**
         * Handles the result of the DELETE requirement request.
         *
         * @param e
         * @private
         */
        _handleDeleteRequirementResponse: function(e) {
          //TODO: check result

          this.toastFeedback = this.localize('reqDelSucc');
          this.$.toast.open();

          // now delete the requirement from the model
          for (var i = 0; i<this.requirements.length; i++) {
            if (this.requirements[i].requirementItem.id === this.requirementToDelete.id) {
              this.splice('requirements', i, 1);
              break;
            }
          }

          this.requirementToDelete = null;
        },

        /**
         * Reset the view when the category id changes.
         *
         * @param categoryId
         * @private
         */
        _categoryIdChanged: function(categoryId) {
          this.resetView();
        },

        resetView: function() {
          //TODO: this seems to be a rather naive approach...
          this.requirements = [];
        },

        _handleRequirementsResponse: function(e) {
          var requirementsResponse = e.detail.response;
          var requirementsToAdd = [];
          // remember scroll position
          //var firstVisibleIndex = this.$.requirementsList.firstVisibleIndex;
          //var scrollTop = this.$.requirementsList._scrollPosition;

          requirementsResponse.forEach(function(requirementItem) {
            // check if the requirement is already existing in the local model
            var existing = false;
            for (var i=0; i<this.requirements.length; i++) {
              if (this.requirements[i].requirementItem.id === requirementItem.id) {
                existing = true;
                break;
              }
            }

            if (!existing) {
              var requirement = {"opened": false, "requirementItem": requirementItem};
              requirementsToAdd.push(requirement);
            }
          }.bind(this));

          // push the items to the requirements array and notify Polymer
          var index = this.requirements.length;
          this.requirements.push.apply(this.requirements, requirementsToAdd);
          this.notifySplices('requirements', [{ index: index, removed: [], addedCount: requirementsToAdd.length, object: this.requirements, type: 'splice'}]);

          // scroll back
          //this.$.scrollThreshold.scroll(0, scrollTop);
          //if (firstVisibleIndex > 0) {
          //  this.$.requirementsList.scrollToIndex(firstVisibleIndex);
          //}

          // if we get back the maximum number of items per page, the likelihood is high that there is another page...
          if (requirementsResponse.length === this._requirementsRequestPerPage) {
            this.$.scrollThreshold.clearTriggers();
          }
        },

        _loadMoreData: function(e) {
          if (this.requirements && (this.requirements.length > 0)) {
            this._requirementsRequestCurrentPage++;
          }
        },

        _handleIronResize: function() {
          //this.$.requirementsList.notifyResize();
        },

        /**
         * A fix for the issue that paper-dropdown within an iron-list disappear behind the next list item.
         * Check https://github.com/PolymerElements/iron-list/issues/242 for the issue.
         *
         * @param e
         * @param detail
         * @private
         */
        _handleMenuOpen: function(e, detail) {
          detail.style.zIndex = 1;
        },

        _handleMenuClose: function(e, detail) {
          detail.style.zIndex = 0;
        },

        /**
         * Shows a toast notification.
         *
         * @param detail a text that is displayed in the toast.
         */
        _handleShowToast: function(e, detail) {
          this.toastFeedback = detail;
          this.$.toast.open();
        },

        _handleDeleteRequirement: function(e, detail) {
          this.requirementToDelete = detail;
          this.$.deleteRequirementDialog.open();
        },

        _handleDeleteComment: function(e, detail) {
          this.commentToDeleteData = detail;
          this.$.deleteCommentDialog.open();
        },

        /**
         * Handles the delete modal dialog closed event.
         *
         * @param e
         * @private
         */
        _handleDeleteCommentDialogClosed: function(e) {
          if (e.detail.confirmed) {
            var commentData = this.commentToDeleteData;
            var request = this.$.deleteCommentRequest;
            request.url = this._apiBaseUrl + '/comments/' + commentData.comment.Id;

            request.generateRequest();
          }
        },

        /**
         * Handles the result of the DELETE requirement request.
         *
         * @param e
         * @private
         */
        _handleDeleteCommentResponse: function(e) {
          this.toastFeedback = this.localize('commentDeleteSuccess');
          this.$.toast.open();

          // now execute the delete callback
          this.commentToDeleteData.onDelete();

          this.commentToDeleteData = null;
        },

        /**
         * Filters the requirements and only returns those whose title or description contains the search filter string.
         *
         * Thanks to https://github.com/PolymerElements/iron-list/issues/193
         *
         * @param requirements
         * @param searchFilter
         */
        filterItems: function(searchFilter) {
          return function(item) { // Array.prototype.filter
            return (item.requirementItem.title && ~item.requirementItem.title.toLowerCase().indexOf(searchFilter.toLowerCase())) || (item.requirementItem.description && ~item.requirementItem.description.toLowerCase().indexOf(searchFilter.toLowerCase()));
          };
        },

        _handleSelectRequirement: function(e, detail) {
          this.push('selectedRequirements', detail.id);

          this.$.bottomToolbar.hidden = (this.selectedRequirements.length === 0);
        },

        _handleUnselectRequirement: function(e, detail) {
          var index = this.selectedRequirements.indexOf(detail.id);
          if (index > -1) {
            this.splice('selectedRequirements', index, 1);
          }

          this.$.bottomToolbar.hidden = (this.selectedRequirements.length === 0);
        },

        /**
         * Still needed for requirements cards in grid view
         */

        /**
         * Calculates the specific star icon to show for the voting feature of the requirements.
         *
         * @param vote the vote field coming from the backend, either 'UP_VOTE' or 'NO_VOTE'.
         * @param authorized whether the user is currently logged in or not.
         * @returns {string} the icon, either a filled star or just the outlines of a star.
         * @private
         */
        _calculateStarIcon: function(vote, authorized) {
          if (authorized && (vote === 'UP_VOTE')) {
            return 'star';
          }
          return 'star-border';
        },

        /**
         * Calculates the CSS class for the star icon of the voting feature of the requirements.
         *
         * @param vote the vote field coming from the backend, either 'UP_VOTE' or 'NO_VOTE'.
         * @param authorized whether the user is currently logged in or not.
         * @returns {string} the CSS class for the star icon.
         * @private
         */
        _calculateStarClass: function(vote, authorized) {
          if (authorized && (vote === 'UP_VOTE')) {
            return 'colored';
          }
        }

      });

    })();
  </script>

</dom-module>
