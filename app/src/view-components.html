<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/app-route/app-route.html">
<link rel="import" href="shared-styles.html">

<dom-module id="view-components">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>

    <app-route
      route="{{route}}"
      pattern="/components/:componentId"
      data="{{data}}"
      tail="{{subroute}}"></app-route>

    <iron-pages
      selected="[[view]]"
      attr-for-selected="name"
      fallback-selection="404"
      role="main"
      content>
      <view-components-list name="components-list" project-id="[[projectId]]" project="{{project}}"></view-components-list>
      <view-requirements name="requirements" id="requirementsView" project-id="[[projectId]]" project="{{project}}" component-id="[[data.componentId]]" route="{{subroute}}"></view-requirements>
      <view-404 name="view404"></view-404>
    </iron-pages>

  </template>

  <script>
    Polymer({
      is: 'view-components',

      properties: {
        route: {
          type: Object,
          notify: true
        },
        view: {
          type: String,
          reflectToAttribute: true,
          observer: '_viewChanged'
        },
        projectId: {
          type: Number
        },
        project: {
          type: Object
        }
      },

      observers: [
        '_dataChanged(data.componentId)',
        '_routeChanged(route)'
      ],

      /**
       * Fired when an attached view wants to register a drawer.
       *
       * @event drawer-registered
       * @param {object} drawer The drawer that is registered.
       */

      _dataChanged: function(componentId) {
        if (componentId) {
          this.view = 'requirements';
        }
      },

      _routeChanged: function(route) {
        if ((route.path === '') || (route.path === '/')) {
          this.view = 'components-list';
        }
      },

      _viewChanged: function(view) {
        // Load view import on demand. Show 404 view if fails
        var resolvedViewUrl = this.resolveUrl('view-' + view + '.html');
        this.importHref(resolvedViewUrl, function(e) {
          // import successful
          if (view === 'requirements') {
            var drawer = this.$.requirementsView.getDrawer();
            this.fire('drawer-registered', {drawerAlign: 'left', drawer: drawer});
          }
        }, this._showView404, true);
      },

      _showView404: function() {
        this.view = 'view404';
      }
    });
  </script>
</dom-module>
