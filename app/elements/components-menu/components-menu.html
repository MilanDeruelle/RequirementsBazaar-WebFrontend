<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="components-menu">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-item {
                --paper-item: {
                    cursor: pointer;
                };
            }

        </style>

        <iron-ajax
                id="componentLoader"
                url="{{componentResourceURL}}"
                last-response="{{component}}"></iron-ajax>

        <iron-ajax
                id="componentsLoader"
                last-response="{{components}}"
                params='{"page":"0", "per_page":"150"}'></iron-ajax>

        <paper-menu>

            <template is="dom-repeat" items="{{components}}">
                <paper-item on-tap="onComponentTap">[[item.name]]</paper-item>
            </template>

        </paper-menu>
    </template>

    <script>
        (function () {
//            'use strict';

            Polymer({
                is: 'components-menu',
                properties: {
                    componentId: {
                        type: Number,
                        notify: true
                    },
                    projectId: {
                        type: Number,
                        computed: 'computeProjectId(component)'
                    },
                    componentResourceURL: {
                        type: String,
                        computed: 'computeComponentResourceURL(componentId)'
                    },
                    component: {
                        type: Object,
                        notify: true,
                        observer: '_componentChanged'
                    },
                    components: {
                        type: Array,
                        notify: true
                    }
                },

                ready: function() {
                },

                computeComponentResourceURL: function(componentId) {
                    return app.baseHref + '/components/' + componentId;
                },

                getComponentsResourceURL: function(projectId) {
                    if (projectId === null) {
                        return null;
                    }
                    return app.baseHref + '/projects/' + projectId + '/components/';
                },

                _componentChanged: function(newValue) {
                    this.$.componentsLoader.url = this.getComponentsResourceURL(newValue.projectId);
                    this.$.componentsLoader.generateRequest();
                },

                computeProjectId: function(component) {
                    if (component === null) {
                        return null;
                    }
                    return component.projectId;
                },

                onComponentTap: function(e) {
                    var model = e.model;
                    page('/projects/'+ this.projectId +'/components/' + model.item.id);
                    document.querySelector("#reqDrawer").togglePanel();
                },

                load: function() {
                    this.$.componentLoader.generateRequest();
                }
            });
        })();
    </script>

</dom-module>
