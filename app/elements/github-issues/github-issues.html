<link rel="import" href="../../components/polymer/polymer.html">

<dom-module id="github-issues">
    <template>
        <style is="custom-style">
            #reposContainer {
                max-width: 80%;
            }
        </style>

        <iron-ajax
            id="getGithubRepos"
            auto
            handle-as="json"
            url="https://api.github.com/user/repos"
            params="{{paramsObject}}"
            content-type="application/json"
            method="GET"
            last-response="{{repositories}}"
            on-error="errorHandler"></iron-ajax>

        <iron-ajax
            id="postIssueGit"
            handle-as="json"
            content-type="application/json"
            params="{{paramsObject}}"
            method="POST"
            on-response="handleResponseGithubIssue"
            on-error="errorHandler"></iron-ajax>

        <iron-ajax
            id="getSearchGit"
            handle-as="json"
            content-type="application/json"
            method="GET"
            last-response="{{searchRepositories}}"
            on-response="showRepoSearchResults"
            on-error="errorHandler"></iron-ajax>


        <paper-dialog id="reposContainer" on-iron-overlay-closed="onRepoDialogClosed">
            <h2>Github Repositories</h2>
            <paper-dialog-scrollable>
                <paper-input id="searchGithubRepo" label="Search a Github Repository" on-keydown="searchGithubRepo">
                    <iron-icon icon="search" prefix></iron-icon>
                </paper-input>
                <iron-selector id="selRepo" selected="0">
                    <template is="dom-repeat" items$="{{repositories}}" id="repoElements">
                        <paper-item>
                            <paper-item-body two-line>
                                <div>{{item.name}}</div>
                                <div secondary>{{item.description}}</div>
                            </paper-item-body>
                        </paper-item>
                    </template>
                </iron-selector>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm autofocus>POST</paper-button>
            </div>
        </paper-dialog>

        <!-- TOAST FOR APP NOTIFICATIONS (FEEDBACK) -->

        <paper-toast id="toast"></paper-toast>

    </template>

    <script>
        (function () {

            Polymer({
                is: 'github-issues',
                properties: {
                    repositories: Array,
                    searchRepositories: Array,
                    access_token: {
                        type: String,
                        value: "a6a52d74665701f2eb37d8f60614303e074d8d07"
                    },
                    paramsObject: {
                        type: Object,
                        computed: '_computeParamsObject(access_token)'
                    },
                    selectedRequirement: Object
                },

                _computeParamsObject: function(acc_token) {
                    return {access_token: acc_token};
                },

                showGithubRepos: function() {
                    this.$.reposContainer.open();
                },

                onRepoDialogClosed: function (e) {
                    if (e.detail.confirmed) {
                        var req = this.$.postIssueGit;
                        req.url = "https://api.github.com/repos/" + this.repositories[parseInt(this.$.selRepo.selected)].full_name + "/issues";
                        req.body = JSON.stringify({
                            "title": this.selectedRequirement.title,
                            "body": this.selectedRequirement.description + "\n" + "More on: https://requirements-bazaar.org" + app.baseUrl + "#!/" + "projects/" + app.params.projectId + "/components/" + app.params.componentId + "/requirements/" + this.selectedRequirement.id
                        });
                        console.log(req.body);
                        req.generateRequest();
                    } else {
                        this.$.selRepo.selected = "0";
                        this.selectedRequirement = null;
                    }
                },

                searchGithubRepo: function (e) {
                    if (e.keyCode === 13) {
                        if (!e.ctrlKey){
                            var req = this.$.getSearchGit;
                            req.url = "https://api.github.com/search/repositories?q=" + encodeURIComponent(this.$.searchGithubRepo.value);
                            req.generateRequest();
                            e.preventDefault();
                        }
                    }
                },

                showRepoSearchResults: function(){
                    this.repositories = this.searchRepositories.items;
                },

                errorHandler: function (e, detail){
                    this.$.toast.text = detail.error.message;
                    this.$.toast.open();
                },

                handleResponseGithubIssue: function(){
                    this.$.toast.text = "Issue posted to Github";
                    this.$.toast.open();
                }

            });
        })
        ();
    </script>

</dom-module>